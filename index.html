<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121522;
      --panel2:#0f1320;
      --border:#22283a;
      --text:#f5f7ff;
      --muted:#98a2b3;

      --purple:#7c3aed;
      --blue:#2563eb;
      --teal:#14b8a6;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;

      --radius:16px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .app{
      width:min(1120px, 94vw);
      margin:18px auto;
      display:grid;
      gap:14px;
      min-height:calc(100vh - 36px);
      grid-template-rows:auto 1fr auto;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    header{
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{ display:flex; flex-direction:column; gap:4px; }
    h1{
      margin:0;
      font-size:1.05rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:900;
    }
    .meta{
      color:var(--muted);
      font-size:.86rem;
      font-weight:700;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .tabs{
      display:inline-flex;
      gap:6px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
    }
    .tab{
      border:0;
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .tab.active{ background:var(--blue); color:#fff; }

    .btn{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{
      border-color:transparent;
      background:var(--purple);
      color:#fff;
    }
    .btn.danger{
      background:transparent;
      border:1px solid #3b1c1c;
      color:#ffb4b4;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    main{
      padding:14px;
      display:grid;
      gap:14px;
      min-height:0;
      grid-template-rows: 0.95fr 1.05fr;
    }

    .section{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .section-title{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
      color:#e9ecff;
    }
    .section-sub{
      margin:4px 0 0;
      color:var(--muted);
      font-size:.85rem;
      font-weight:700;
    }

    .section .section-body{
      min-height:0;
      overflow:auto;
      padding-top:2px;
      flex: 1 1 auto;
    }

    .empty{
      border:1px dashed #3a425c;
      border-radius:14px;
      padding:18px;
      background:#0c0f19;
      color:var(--muted);
      text-align:center;
      font-weight:800;
    }

    /* Table wrapper (both weekly + monthly) */
    .table-wrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0c0f19;
      min-height:0;
      flex:1;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px; /* ensures side-scroll works */
    }

    th, td{
      border-bottom:1px solid var(--border);
      padding:10px;
      text-align:center;
      font-size:.92rem;
      background:#0c0f19;
      white-space:nowrap;
    }

    th{
      position:sticky;
      top:0;
      z-index:5;
      background:#0f1320;
      color:#dbe1ff;
      font-size:.78rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
    }

    /* Sticky first column */
    th:first-child, td:first-child{
      position:sticky;
      left:0;
      z-index:4;
      text-align:left;
      background:#0c0f19;
      border-right:1px solid var(--border);
    }
    th:first-child{
      z-index:6;
      background:#0f1320;
    }

    .habit-cell{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:280px; /* wider habit column */
    }
    .habit-dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background:var(--blue);
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .habit-name{
      font-weight:900;
      letter-spacing:.01em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:260px;
      cursor:pointer; /* click-to-edit */
    }
    .habit-kind{
      margin-left:auto;
      font-size:.70rem;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:#cbd5ff;
      background:#11162a;
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      flex:0 0 auto;
    }

    input[type="checkbox"]{
      appearance:none;
      -webkit-appearance:none;
      width:22px;
      height:22px;
      border-radius:6px;
      border:1px solid #3a425c;
      background:#0b0d12;
      cursor:pointer;
      position:relative;
    }
    input[type="checkbox"]:checked{
      border-color:transparent;
      background:var(--accent, var(--blue));
    }
    input[type="checkbox"]:checked::after{
      content:'';
      position:absolute;
      left:7px;
      top:2px;
      width:5px;
      height:11px;
      border:solid #fff;
      border-width:0 2px 2px 0;
      transform:rotate(45deg);
    }

    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      min-width:160px;
    }
    .bar{
      width:140px;
      height:10px;
      border-radius:999px;
      background:#141a2b;
      border:1px solid var(--border);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background:var(--accent, var(--purple));
    }
    .pct{
      min-width:52px;
      text-align:right;
      color:var(--muted);
      font-weight:900;
      font-size:.85rem;
    }

    /* Insights */
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1.2fr 0.8fr;
      min-height:0;
      flex:1;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:12px;
      min-height:0;
      align-content:start;
    }

    .card{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      text-align:left;
      cursor:default;
    }
    button.card{
      cursor:pointer;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
    }
    button.card:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .card-title{
      font-weight:900;
      letter-spacing:.02em;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .ring-center{
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
    }
    .ring{
      width:96px;
      height:96px;
      flex:0 0 auto;
    }
    .ring text{
      font-weight:900;
      fill:#fff;
      font-size:10px;
      letter-spacing:.06em;
    }

    .list{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .list h3{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .items{
      overflow:auto;
      padding-right:4px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#0f1320;
    }
    .item small{ color:var(--muted); font-weight:900; }

    button.item{
      width:100%;
      cursor:pointer;

      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;

      appearance:none;
      -webkit-appearance:none;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
      padding:0;
    }
    button.item:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.75rem;
      color:#fff;
      white-space:nowrap;
    }
    .badge.bad{ background:var(--red); }
    .badge.warn{ background:var(--amber); }
    .badge.ok{ background:var(--green); }
    .badge.new{ background:#475569; }
    .badge.streak{ background:var(--purple); }

    .coach{
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
    }
    .coach-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .coach-title{
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.88rem;
      margin:0;
    }
    .coach-box{
      border:1px solid var(--border);
      background:#0f1320;
      border-radius:14px;
      padding:10px;
      color:#dbe1ff;
      font-weight:800;
      line-height:1.35;
    }
    .coach-box ul{ margin:8px 0 0 18px; padding:0; }
    .coach-box li{ margin:6px 0; }

    /* Footer */
    footer{
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .foot-note{ color:var(--muted); font-size:.82rem; font-weight:800; }

    /* Expand-to-full system */
    body[data-expanded] { overflow: hidden; }
    body[data-expanded]::before{
      content:"";
      position:fixed;
      inset:0;
      background:#070912;
      opacity:.88;
      z-index:9998;
    }

    body[data-expanded="ops"] #insightsSection,
    body[data-expanded="insights"] #opsSection {
      display:none;
    }

    body[data-expanded] #opsSection,
    body[data-expanded] #insightsSection {
      position:fixed;
      inset:14px;
      z-index:9999;
      border-radius:var(--radius);
      background:var(--panel2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }

    [data-close]{ display:none; }
    body[data-expanded] [data-close]{ display:inline-flex !important; }
    body[data-expanded] [data-expand]{ display:none !important; }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(7,9,18,.88);
      z-index:10000;
      display:none;
      align-items:stretch;
      justify-content:center;
      padding:14px;
    }
    .modal-backdrop[data-open="true"]{ display:flex; }
    .modal{
      width:min(760px, 100%);
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .modal-head{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-title{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .modal-body{
      padding:12px;
      display:grid;
      gap:12px;
      min-height:0;
      overflow:auto;
    }
    .field{ display:grid; gap:8px; }
    .label{
      color:var(--muted);
      font-size:.82rem;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .input{
      width:100%;
      border:1px solid var(--border);
      background:#0c0f19;
      color:var(--text);
      border-radius:14px;
      padding:12px;
      font-weight:900;
      outline:none;
    }
    .row2{
      display:grid;
      gap:12px;
      grid-template-columns:1fr 1fr;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      border:1px solid var(--border);
      background:#0c0f19;
      color:#dbe1ff;
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.75rem;
    }
    .chip[data-active="true"]{
      border-color:transparent;
      background:var(--blue);
      color:#fff;
    }

    .palette{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap:8px;
    }
    .swatch{
      height:28px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
      position:relative;
      background:var(--c);
    }
    .swatch[data-active="true"]::after{
      content:"";
      position:absolute;
      inset:6px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,.85);
    }

    .modal-foot{
      padding:12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    @media (max-width: 980px){
      main{ grid-template-rows:auto auto; }
      .grid{ grid-template-columns:1fr; }
      .habit-cell{ min-width:240px; }
      table{ min-width:900px; }
    }
    @media (max-width: 720px){
      .row2{ grid-template-columns:1fr; }
      .palette{ grid-template-columns: repeat(8, minmax(0,1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <h1>Habit Tracker</h1>
        <div class="meta" id="dateMeta"></div>
      </div>

      <div class="controls">
        <nav class="tabs" aria-label="Main Tabs">
          <button class="tab active" data-tab="habits">Habits</button>
          <button class="tab" data-tab="insights">Insights</button>
        </nav>

        <nav class="tabs" aria-label="View Switcher" id="viewSwitcher">
          <button class="tab active" data-view="weekly">Weekly</button>
          <button class="tab" data-view="monthly">Monthly</button>
        </nav>

        <button class="btn" id="exportBtn">Export</button>
        <button class="btn primary" id="addHabitBtn">+ Habit</button>
      </div>
    </header>

    <main class="panel" id="mainShell"></main>

    <footer class="panel">
      <div class="foot-note">Saved locally on this device.</div>
      <button class="btn danger" id="resetBtn">Reset</button>
    </footer>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Habit editor">
    <div class="modal">
      <div class="modal-head">
        <h2 class="modal-title" id="modalTitle">Add Habit</h2>
        <button class="btn" id="modalCloseBtn" type="button">Close (Esc)</button>
      </div>

      <div class="modal-body">
        <div class="field">
          <div class="label">Habit name</div>
          <input class="input" id="habitNameInput" type="text" placeholder="e.g., Water, Run, Study..." maxlength="60" />
        </div>

        <div class="row2">
          <div class="field">
            <div class="label">Category</div>
            <div class="chips" id="kindChips"></div>
          </div>

          <div class="field">
            <div class="label">Color</div>
            <div class="palette" id="colorPalette"></div>
          </div>
        </div>

        <div class="field" id="modalDangerZone" style="display:none;">
          <div class="label">Danger zone</div>
          <button class="btn danger" type="button" id="deleteHabitBtn">Delete habit</button>
        </div>
      </div>

      <div class="modal-foot">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="modalCancelBtn" type="button">Cancel</button>
          <button class="btn primary" id="modalSaveBtn" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Constants =========
    const STORAGE_KEY = 'habit-tracker-stack-v1_1';

    const KINDS = [
      { key:'body', label:'Body' },
      { key:'mind', label:'Mind' },
      { key:'order', label:'Order' },
      { key:'craft', label:'Craft' },
      { key:'money', label:'Money' }
    ];

    // 24 solid colors
    const PALETTE = [
      '#7c3aed', '#2563eb', '#14b8a6', '#22c55e', '#f59e0b', '#ef4444',
      '#ec4899', '#a855f7', '#0ea5e9', '#10b981', '#84cc16', '#eab308',
      '#f97316', '#dc2626', '#fb7185', '#64748b', '#8b5cf6', '#1d4ed8',
      '#0891b2', '#16a34a', '#65a30d', '#d97706', '#ea580c', '#be123c'
    ];

    // ========= State =========
    const appState = load() || { habits: [] };
    let activeTab = 'habits';
    let activeView = 'weekly';
    let insightsDetailHabitId = null;

    // modal
    let modalOpen = false;
    let modalMode = 'add'; // add | edit
    let modalHabitId = null;
    let modalKind = 'body';
    let modalColorIdx = 0;

    // fullscreen
    let lastFocus = null;

    // ========= Persistence =========
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return null;
        parsed.habits = parsed.habits.map(h => ({
          id: String(h.id || crypto.randomUUID()),
          name: String(h.name || 'Untitled Habit'),
          kind: String(h.kind || 'body'),
          colorIdx: Number.isFinite(h.colorIdx) ? h.colorIdx : 0,
          created: h.created || new Date().toISOString(),
          completions: Array.isArray(h.completions) ? h.completions : []
        }));
        return parsed;
      }catch{ return null; }
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

    function update(mutator){
      mutator(appState);
      save();
      render();
    }

    // ========= Dates =========
    function key(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function isoWeek(ref = new Date()){
      const base = new Date(ref);
      const day = base.getDay();
      const shift = day === 0 ? -6 : 1 - day;
      base.setDate(base.getDate() + shift);
      base.setHours(0,0,0,0);
      return Array.from({length:7}, (_,i)=>{
        const d = new Date(base);
        d.setDate(base.getDate()+i);
        return d;
      });
    }

    function monthDays(ref = new Date()){
      const y = ref.getFullYear();
      const m = ref.getMonth();
      const count = new Date(y, m+1, 0).getDate();
      return Array.from({length:count}, (_,i)=> new Date(y, m, i+1));
    }

    // ========= Habit logic =========
    function done(habit, dateKey){ return habit.completions.includes(dateKey); }

    function toggle(habitId, dateKey, checked){
      update((s)=>{
        const h = s.habits.find(x=>x.id===habitId);
        if(!h) return;
        const set = new Set(h.completions);
        if(checked) set.add(dateKey); else set.delete(dateKey);
        h.completions = [...set].sort();
      });
    }

    function countInRange(habit, dates){
      return dates.reduce((sum, d)=> sum + (done(habit, key(d)) ? 1 : 0), 0);
    }

    function lastDoneDaysAgo(habit){
      if(!habit.completions.length) return Infinity;
      const last = habit.completions[habit.completions.length - 1];
      const lastDate = new Date(last + 'T00:00:00');
      const today = new Date(); today.setHours(0,0,0,0);
      return Math.floor((today - lastDate) / (1000*60*60*24));
    }

    function createdDaysAgo(habit){
      const c = new Date(habit.created); c.setHours(0,0,0,0);
      const today = new Date(); today.setHours(0,0,0,0);
      return Math.floor((today - c) / (1000*60*60*24));
    }

    // ========= Sorting (category then name) =========
    const KIND_ORDER = new Map(KINDS.map((k,i)=> [k.key, i]));
    function sortedHabits(habits){
      return [...habits].sort((a,b)=>{
        const ka = KIND_ORDER.has(a.kind) ? KIND_ORDER.get(a.kind) : 999;
        const kb = KIND_ORDER.has(b.kind) ? KIND_ORDER.get(b.kind) : 999;
        if(ka !== kb) return ka - kb;
        return a.name.localeCompare(b.name);
      });
    }

    // ========= UI helpers =========
    function esc(s){
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function setMeta(){
      const now = new Date();
      document.getElementById('dateMeta').textContent = now.toLocaleString(undefined, {
        weekday:'long', year:'numeric', month:'long', day:'numeric'
      });
    }

    function statusColorByPct(pct){
      if(pct < 25) return 'var(--red)';
      if(pct < 50) return 'var(--amber)';
      if(pct < 75) return 'var(--teal)';
      return 'var(--green)';
    }

    function neglectedBadge(habit){
      const since = lastDoneDaysAgo(habit);
      const age = createdDaysAgo(habit);

      if(age <= 2 && habit.completions.length === 0) return { cls:'new', label:'NEW' };
      if(since === Infinity) return { cls:'bad', label:'Never completed' };
      if(since >= 7) return { cls:'bad', label:`${since}d since last` };
      if(since >= 3) return { cls:'warn', label:`${since}d since last` };
      return { cls:'ok', label:`${since}d since last` };
    }

    function pctText(p){ return `${Math.max(0, Math.min(100, p))}%`; }

    function ringSVG(percent, color){
      const size=96, r=36, cx=size/2, cy=size/2;
      const c=2*Math.PI*r;
      const p=Math.max(0, Math.min(100, percent));
      const off=c*(1-p/100);
      return `
        <svg class="ring" viewBox="0 0 ${size} ${size}">
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#1b2236" stroke-width="10" />
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${color}" stroke-width="10"
                  stroke-linecap="round"
                  stroke-dasharray="${c}"
                  stroke-dashoffset="${off}"
                  transform="rotate(-90 ${cx} ${cy})"/>
          <text x="${cx}" y="${cy+4}" text-anchor="middle">${p}%</text>
        </svg>
      `;
    }

    // ========= Modal =========
    function pickNextColorIdx(){
      const used = new Map();
      appState.habits.forEach(h=>{
        const idx = Number.isFinite(h.colorIdx) ? h.colorIdx : 0;
        used.set(idx, (used.get(idx)||0)+1);
      });
      let best = 0, bestCount = Infinity;
      for(let i=0;i<PALETTE.length;i++){
        const c = used.get(i) || 0;
        if(c < bestCount){ bestCount = c; best = i; }
      }
      return best;
    }

    function renderModalKindChips(){
      const host = document.getElementById('kindChips');
      host.innerHTML = '';
      KINDS.forEach(k=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='chip';
        b.textContent = k.label;
        b.setAttribute('data-active', String(k.key===modalKind));
        b.addEventListener('click', ()=>{
          modalKind = k.key;
          renderModalKindChips();
        });
        host.appendChild(b);
      });
    }

    function renderModalPalette(){
      const host = document.getElementById('colorPalette');
      host.innerHTML = '';
      PALETTE.forEach((c, idx)=>{
        const d = document.createElement('button');
        d.type='button';
        d.className='swatch';
        d.style.setProperty('--c', c);
        d.setAttribute('data-active', String(idx===modalColorIdx));
        d.addEventListener('click', ()=>{
          modalColorIdx = idx;
          renderModalPalette();
        });
        host.appendChild(d);
      });
    }

    function openModal(mode, habit){
      modalMode = mode;
      modalHabitId = habit ? habit.id : null;
      modalKind = habit ? habit.kind : 'body';
      modalColorIdx = habit ? habit.colorIdx : pickNextColorIdx();
      modalOpen = true;

      document.getElementById('modalTitle').textContent = mode === 'edit' ? 'Edit Habit' : 'Add Habit';
      document.getElementById('habitNameInput').value = habit ? habit.name : '';
      document.getElementById('modalDangerZone').style.display = mode === 'edit' ? 'block' : 'none';

      renderModalKindChips();
      renderModalPalette();

      document.getElementById('modalBackdrop').setAttribute('data-open','true');
      requestAnimationFrame(()=> document.getElementById('habitNameInput').focus());
    }

    function closeModal(){
      modalOpen = false;
      modalMode = 'add';
      modalHabitId = null;
      document.getElementById('modalBackdrop').removeAttribute('data-open');
      render();
    }

    function saveModal(){
      const name = String(document.getElementById('habitNameInput').value || '').trim();
      if(!name) return;

      if(modalMode === 'add'){
        update((s)=>{
          s.habits.push({
            id: crypto.randomUUID(),
            name,
            kind: modalKind,
            colorIdx: modalColorIdx,
            created: new Date().toISOString(),
            completions: []
          });
        });
      }else{
        update((s)=>{
          const h = s.habits.find(x=>x.id===modalHabitId);
          if(!h) return;
          h.name = name;
          h.kind = modalKind;
          h.colorIdx = modalColorIdx;
        });
      }
      closeModal();
    }

    function deleteModalHabit(){
      if(modalMode !== 'edit') return;
      const h = appState.habits.find(x=>x.id===modalHabitId);
      if(!h) return;

      const ok = confirm(`Delete "${h.name}"? This removes its history on this device.`);
      if(!ok) return;

      update((s)=>{
        s.habits = s.habits.filter(x=>x.id!==modalHabitId);
      });
      closeModal();
    }

    // ========= Rendering =========
    function render(){
      setMeta();
      const shell = document.getElementById('mainShell');
      shell.innerHTML = '';

      // show/hide view switcher
      document.getElementById('viewSwitcher').style.display = (activeTab === 'habits') ? 'inline-flex' : 'none';

      if(activeTab === 'habits'){
        shell.appendChild(renderHabitsSection());
      }else{
        shell.appendChild(renderInsightsSection());
      }

      bindDynamic(shell);
    }

    function renderHabitsSection(){
      const wrap = document.createElement('section');
      wrap.className='section';
      wrap.id='opsSection';

      const weekDates = isoWeek();
      const start = weekDates[0].toLocaleDateString();
      const end = weekDates[6].toLocaleDateString();
      const label = activeView === 'weekly'
        ? `Week (Mon–Sun): ${start} → ${end}`
        : `Month: ${new Date().toLocaleString(undefined, {month:'long', year:'numeric'})}`;

      const head = document.createElement('div');
      head.className='section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">Habits</h2>
          <p class="section-sub">${esc(label)} • Click habit name to edit</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="ops">Expand</button>
          <button class="btn" data-close>Close (Esc)</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className='section-body';

      body.appendChild(renderHabitsTable());

      wrap.appendChild(head);
      wrap.appendChild(body);
      return wrap;
    }

    function renderHabitsTable(){
      const container = document.createElement('div');

      if(!appState.habits.length){
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='No habits yet. Click “+ Habit”.';
        container.appendChild(e);
        return container;
      }

      const habits = sortedHabits(appState.habits);

      const tableWrap = document.createElement('div');
      tableWrap.className='table-wrap';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');

      if(activeView === 'weekly'){
        const weekDates = isoWeek();
        hr.innerHTML = `<th>Habit</th>${['M','T','W','T','F','S','S'].map(d=>`<th>${d}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(hr);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');
          const doneCount = countInRange(h, weekDates);
          const pct = Math.round((doneCount/7)*100);
          const accent = PALETTE[h.colorIdx % PALETTE.length];

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}">
                <span class="habit-dot" style="background:${accent}"></span>
                <div class="habit-name" title="Click to edit">${esc(h.name)}</div>
                <span class="habit-kind">${esc(h.kind)}</span>
              </div>
            </td>
          `;

          weekDates.forEach(d=>{
            const dk = key(d);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td>
              <input type="checkbox" style="--accent:${accent}"
                     data-habit-id="${h.id}" data-date="${dk}" ${checked}
                     aria-label="${esc(h.name)} ${dk}">
            </td>`;
          });

          row += `
            <td>
              <div class="progress" style="--accent:${accent}">
                <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
                <div class="pct">${pctText(pct)}</div>
              </div>
            </td>
          `;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      }else{
        const now = new Date();
        const md = monthDays(now);
        const dim = md.length;

        hr.innerHTML = `<th>Habit</th>${Array.from({length:31}, (_,i)=>`<th>${i+1}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(hr);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');
          const doneCount = countInRange(h, md);
          const pct = Math.round((doneCount/dim)*100);
          const accent = PALETTE[h.colorIdx % PALETTE.length];

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}">
                <span class="habit-dot" style="background:${accent}"></span>
                <div class="habit-name" title="Click to edit">${esc(h.name)}</div>
                <span class="habit-kind">${esc(h.kind)}</span>
              </div>
            </td>
          `;

          for(let day=1; day<=31; day++){
            const date = md[day-1];
            if(!date){
              row += `<td style="opacity:.30">—</td>`;
              continue;
            }
            const dk = key(date);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td>
              <input type="checkbox" style="--accent:${accent}"
                     data-habit-id="${h.id}" data-date="${dk}" ${checked}
                     aria-label="${esc(h.name)} ${dk}">
            </td>`;
          }

          row += `
            <td>
              <div class="progress" style="--accent:${accent}">
                <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
                <div class="pct">${pctText(pct)}</div>
              </div>
            </td>
          `;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      }

      tableWrap.appendChild(table);
      container.appendChild(tableWrap);
      return container;
    }

    function renderInsightsSection(){
      const wrap = document.createElement('section');
      wrap.className='section';
      wrap.id='insightsSection';

      const head = document.createElement('div');
      head.className='section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">Insights</h2>
          <p class="section-sub">Title + ring only. Neglected shows exact meaning.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="insights">Expand</button>
          <button class="btn" data-close>Close (Esc)</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className='section-body';

      if(!appState.habits.length){
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='Add habits to see insights.';
        body.appendChild(e);
      }else{
        body.appendChild(renderInsightsBody());
      }

      wrap.appendChild(head);
      wrap.appendChild(body);
      return wrap;
    }

    function renderInsightsBody(){
      const container = document.createElement('div');

      if(insightsDetailHabitId){
        const d = document.createElement('div');
        d.className='empty';
        d.textContent='Detail view not implemented in this rewrite (kept minimalist).';
        container.appendChild(d);
        return container;
      }

      const now = new Date();
      const m = monthDays(now);
      const dim = m.length;

      const ranked = sortedHabits(appState.habits).map(h=>{
        const monthDone = countInRange(h, m);
        const monthPct = Math.round((monthDone/dim)*100);
        const since = lastDoneDaysAgo(h);
        return { h, monthPct, since };
      });

      const grid = document.createElement('div');
      grid.className='grid';

      const cards = document.createElement('div');
      cards.className='cards';

      ranked.forEach(r=>{
        const ringColor = statusColorByPct(r.monthPct);

        const card = document.createElement('button');
        card.type='button';
        card.className='card';
        card.setAttribute('data-open-habit', r.h.id);
        card.innerHTML = `
          <div class="card-title">${esc(r.h.name)}</div>
          <div class="ring-center">${ringSVG(r.monthPct, ringColor)}</div>
        `;
        cards.appendChild(card);
      });

      const right = document.createElement('div');
      right.style.display='flex';
      right.style.flexDirection='column';
      right.style.gap='12px';
      right.style.minHeight='0';

      const list = document.createElement('div');
      list.className='list';
      list.innerHTML = `<h3>Neglected</h3><div class="items"></div>`;
      const items = list.querySelector('.items');

      const neglected = [...ranked].sort((a,b)=>{
        const sa = a.since === Infinity ? 9999 : a.since;
        const sb = b.since === Infinity ? 9999 : b.since;
        return sb - sa;
      }).slice(0, 12);

      neglected.forEach(r=>{
        const b = neglectedBadge(r.h);
        const item = document.createElement('button');
        item.type='button';
        item.className='item';
        item.setAttribute('data-open-habit', r.h.id);

        const sinceText = (r.since === Infinity)
          ? 'Never completed'
          : `${r.since} day(s) since last completion`;

        item.innerHTML = `
          <div>
            <div style="font-weight:900">${esc(r.h.name)}</div>
            <small>${esc(sinceText)}</small>
          </div>
          <div class="badge ${b.cls}">${esc(b.label)}</div>
        `;
        items.appendChild(item);
      });

      right.appendChild(list);

      grid.appendChild(cards);
      grid.appendChild(right);

      container.appendChild(grid);
      return container;
    }

    function bindDynamic(root){
      root.querySelectorAll('input[type="checkbox"]').forEach(box=>{
        box.addEventListener('change', (e)=>{
          const { habitId, date } = e.target.dataset;
          toggle(habitId, date, e.target.checked);
        });
      });
    }

    // ========= Controls =========
    function bindControls(){
      // main tabs
      document.querySelectorAll('.tab[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          activeTab = btn.dataset.tab;
          document.querySelectorAll('.tab[data-tab]').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          render();
        });
      });

      // weekly/monthly
      document.querySelectorAll('.tab[data-view]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          activeView = btn.dataset.view;
          document.querySelectorAll('.tab[data-view]').forEach(t=>t.classList.remove('active'));
          btn.classList.add('active');
          render();
        });
      });

      // add
      document.getElementById('addHabitBtn').addEventListener('click', ()=> openModal('add', null));

      // export
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(appState, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-tracker-${key(new Date())}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        const ok = confirm('Reset deletes habits + history on this device. Continue?');
        if(!ok) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      // modal
      document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
      document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
      document.getElementById('modalSaveBtn').addEventListener('click', saveModal);
      document.getElementById('deleteHabitBtn').addEventListener('click', deleteModalHabit);

      document.getElementById('modalBackdrop').addEventListener('click', (e)=>{
        if(e.target.id === 'modalBackdrop') closeModal();
      });
    }

    // ========= Global click + key handling =========
    document.addEventListener('click', (e)=>{
      // edit by clicking habit cell
      const editCell = e.target.closest('[data-edit-habit]');
      if(editCell){
        const id = editCell.getAttribute('data-edit-habit');
        const h = appState.habits.find(x=>x.id===id);
        if(h) openModal('edit', h);
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modalOpen) closeModal();
    });

    // ========= Init =========
    function init(){
      bindControls();
      render();
    }
    init();
  </script>
</body>
</html>
