<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121522;
      --panel2:#0f1320;
      --border:#22283a;
      --text:#f5f7ff;
      --muted:#98a2b3;

      --purple:#7c3aed;
      --blue:#2563eb;
      --teal:#14b8a6;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;
      --pink:#ec4899;
      --slate:#64748b;

      --radius:16px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .app{
      width:min(1120px, 94vw);
      margin:18px auto;
      display:grid;
      gap:14px;
      min-height:calc(100vh - 36px);
      grid-template-rows:auto 1fr auto;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    header{
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      margin:0;
      font-size:1.05rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:900;
    }
    .meta{
      color:var(--muted);
      font-size:.86rem;
      font-weight:700;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .tabs{
      display:inline-flex;
      gap:6px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
    }
    .tab{
      border:0;
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.02em;
    }
    .tab.active{
      background:var(--blue);
      color:#fff;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      border-color:transparent;
      background:var(--purple);
      color:#fff;
    }
    .btn.danger{
      border-color:transparent;
      background:var(--red);
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    main{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }

    .section{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex: 1 1 auto;
    }

    .section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .section-title{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
      color:#e9ecff;
    }
    .section-sub{
      margin:4px 0 0;
      color:var(--muted);
      font-size:.85rem;
      font-weight:700;
    }

    .empty{
      border:1px dashed #3a425c;
      border-radius:14px;
      padding:18px;
      background:#0c0f19;
      color:var(--muted);
      text-align:center;
      font-weight:800;
    }

    /* table */
    .table-wrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0c0f19;
      min-height:0;
      flex:1;
    }
    table{
      width:100%;
      min-width:860px;
      border-collapse:collapse;
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:10px;
      text-align:center;
      font-size:.92rem;
      background:#0c0f19;
      white-space:nowrap;
    }
    th{
      position:sticky;
      top:0;
      z-index:3;
      background:#0f1320;
      color:#dbe1ff;
      font-size:.78rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
    }

    /* sticky first column */
    th:first-child, td:first-child{
      text-align:left;
      min-width:320px; /* wider habit column */
      position:sticky;
      left:0;
      z-index:2;
      background:#0c0f19;
      border-right:1px solid var(--border);
    }
    th:first-child{
      z-index:4;
      background:#0f1320;
    }
    th:last-child, td:last-child{
      border-left:1px solid var(--border);
    }

    .habit-cell{
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      user-select:none;
    }
    .habit-name{
      font-weight:900;
      letter-spacing:.01em;
      line-height:1.15;
    }
    .habit-meta{
      display:flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-weight:900;
      font-size:.78rem;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: var(--slate);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto;
    }

    input[type="checkbox"]{
      appearance:none;
      -webkit-appearance:none;
      width:22px;
      height:22px;
      border-radius:6px;
      border:1px solid #3a425c;
      background:#0b0d12;
      cursor:pointer;
      position:relative;
    }
    input[type="checkbox"]:checked{
      border-color:transparent;
      background: var(--chk, var(--blue));
    }
    input[type="checkbox"]:checked::after{
      content:'';
      position:absolute;
      left:7px;
      top:2px;
      width:5px;
      height:11px;
      border:solid #fff;
      border-width:0 2px 2px 0;
      transform:rotate(45deg);
    }

    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
    }
    .bar{
      width:120px;
      height:10px;
      border-radius:999px;
      background:#141a2b;
      border:1px solid var(--border);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background: var(--fill, var(--purple));
    }
    .pct{
      min-width:64px;
      text-align:right;
      color:var(--muted);
      font-weight:900;
      font-size:.85rem;
    }

    /* insights layout */
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1.2fr 0.8fr;
      min-height:0;
      flex:1;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap:10px; /* tighter */
      min-height:0;
      align-content:start;
    }

    .card{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      text-align:left;
      cursor:default;
    }
    button.card{
      cursor:pointer;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
    }
    button.card:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .mini-card-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .mini-name{
      font-weight:900;
      line-height:1.15;
      letter-spacing:.01em;
      font-size:.92rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .ring-center{
      display:flex;
      align-items:center;
      justify-content:center;
      padding-top:6px;
    }
    .ring{
      width:92px;
      height:92px;
    }
    .ring text{
      font-weight:900;
      fill:#fff;
      font-size:10px;
      letter-spacing:.06em;
    }

    .pill{
      font-size:.75rem;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:#11162a;
      border:1px solid var(--border);
      color:#dbe1ff;
      white-space:nowrap;
    }

    .list{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .list h3{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .items{
      overflow:auto;
      padding-right:4px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#0f1320;
    }
    .item small{ color:var(--muted); font-weight:900; }

    button.item{
      width:100%;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      appearance:none;
      -webkit-appearance:none;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
      padding:0;
    }
    button.item:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.75rem;
      color:#fff;
      white-space:nowrap;
    }
    .badge.bad{ background:var(--red); }
    .badge.warn{ background:var(--amber); }
    .badge.ok{ background:var(--green); }
    .badge.new{ background:var(--slate); }

    .coach{
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
    }
    .coach-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .coach-title{
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.88rem;
      margin:0;
    }
    .coach-box{
      border:1px solid var(--border);
      background:#0f1320;
      border-radius:14px;
      padding:10px;
      color:#dbe1ff;
      font-weight:800;
      line-height:1.35;
    }
    .coach-box ul{ margin:8px 0 0 18px; padding:0; }
    .coach-box li{ margin:6px 0; }

    /* footer */
    footer{
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .foot-note{ color:var(--muted); font-size:.82rem; font-weight:800; }

    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      th:first-child, td:first-child{ min-width:260px; }
    }

    /* Expand-to-full */
    body[data-expanded] { overflow: hidden; }
    body[data-expanded]::before{
      content:"";
      position:fixed;
      inset:0;
      background:#070912;
      opacity:.88;
      z-index:9998;
    }
    .section .section-body{
      min-height:0;
      overflow:auto;
      padding-top:2px;
      flex: 1 1 auto;
    }
    body[data-expanded="ops"] #insightsSection,
    body[data-expanded="insights"] #opsSection,
    body[data-expanded="ovr"] #opsSection,
    body[data-expanded="ovr"] #insightsSection{
      display:none;
    }
    body[data-expanded] #opsSection,
    body[data-expanded] #insightsSection,
    body[data-expanded] #ovrSection{
      position: fixed;
      inset: 14px;
      z-index: 9999;
      border-radius: var(--radius);
      background: var(--panel2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    [data-close]{ display:none; }
    body[data-expanded] [data-close]{ display:inline-flex !important; }
    body[data-expanded] [data-expand] { display:none !important; }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      z-index:10000;
    }
    .modal[data-open="true"]{ display:block; }
    .modal::before{
      content:"";
      position:absolute;
      inset:0;
      background:#070912;
      opacity:.88;
    }
    .modal-card{
      position:relative;
      width:min(560px, 92vw);
      margin:8vh auto;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .modal-title{
      margin:0;
      font-size:.9rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .form{
      display:grid;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      color:var(--muted);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.75rem;
    }
    .input, .select{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* OVR */
    .ovr-wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      flex:1;
    }
    .ovr-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:14px 0;
    }
    .ovr-rank{
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:1rem;
    }
    .ovr-sub{
      color:var(--muted);
      font-weight:900;
      font-size:.85rem;
      text-align:center;
      max-width:42ch;
      line-height:1.35;
    }
    .emblem{
      width:140px;
      height:140px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <h1>Habit Tracker</h1>
        <div class="meta" id="dateMeta"></div>
      </div>

      <div class="controls">
        <nav class="tabs" aria-label="Top Tabs">
          <button class="tab active" data-tab="habits">Habits</button>
          <button class="tab" data-tab="insights">Insights</button>
          <button class="tab" data-tab="ovr">OVR</button>
        </nav>

        <nav class="tabs" aria-label="View Switcher" id="viewTabs">
          <button class="tab active" data-view="weekly">Weekly</button>
          <button class="tab" data-view="monthly">Monthly</button>
        </nav>

        <button class="btn" id="exportBtn" title="Export full state as JSON">Export</button>
        <button class="btn primary" id="addHabitBtn">+ Habit</button>
      </div>
    </header>

    <main class="panel" id="mainShell"></main>

    <footer class="panel">
      <div class="foot-note">Saved locally on this device.</div>
      <button class="btn" id="resetBtn" title="Clear local data">Reset</button>
    </footer>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" id="habitModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="habitModalTitle">
      <div class="modal-head">
        <div>
          <h2 class="modal-title" id="habitModalTitle">Habit</h2>
          <div class="section-sub" id="habitModalSub">Create or edit a habit.</div>
        </div>
        <button class="btn" id="habitModalClose" type="button">Close</button>
      </div>

      <div class="form">
        <div class="field">
          <div class="label">Name</div>
          <input class="input" id="habitNameInput" type="text" placeholder="e.g., Gym, Read 10 pages, Budget review" />
        </div>

        <div class="field">
          <div class="label">Category</div>
          <select class="select" id="habitCategorySelect">
            <option value="Body">Body</option>
            <option value="Mind">Mind</option>
            <option value="Order">Order</option>
            <option value="Craft">Craft</option>
            <option value="Money">Money</option>
            <option value="Relationships">Relationships</option>
            <option value="Spirit">Spirit</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="row">
          <button class="btn danger" id="deleteHabitBtn" type="button" style="margin-right:auto; display:none;">Delete</button>
          <button class="btn" id="cancelHabitBtn" type="button">Cancel</button>
          <button class="btn primary" id="saveHabitBtn" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= Palette (24 solid colors) =========
    const PALETTE = [
      "#7c3aed","#2563eb","#14b8a6","#22c55e","#f59e0b","#ef4444",
      "#ec4899","#64748b","#a855f7","#0ea5e9","#06b6d4","#16a34a",
      "#eab308","#f97316","#dc2626","#db2777","#475569","#9333ea",
      "#1d4ed8","#0f766e","#15803d","#ca8a04","#c2410c","#b91c1c"
    ];

    // ========= State =========
    const STORAGE_KEY = 'habit-tracker-solid-coach-v1_1';
    const appState = load() || { habits: [], ui: { activeTab:'habits', activeView:'weekly' } };

    let insightsDetailHabitId = null; // optional (kept for future), currently not used
    let lastFocus = null;

    // modal editing
    let modalMode = "add"; // add | edit
    let editingHabitId = null;

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return null;
        parsed.ui = parsed.ui || { activeTab:'habits', activeView:'weekly' };
        parsed.habits = parsed.habits.map(h => ({
          id: String(h.id || crypto.randomUUID()),
          name: String(h.name || 'Untitled Habit'),
          category: String(h.category || 'Other'),
          colorIndex: Number.isFinite(h.colorIndex) ? h.colorIndex : 0,
          created: h.created || new Date().toISOString(),
          completions: Array.isArray(h.completions) ? h.completions : []
        }));
        return parsed;
      }catch{ return null; }
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

    function update(mutator){
      mutator(appState);
      save();
      render();
    }

    // ========= Dates =========
    function key(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function isoWeek(ref = new Date()){
      const base = new Date(ref);
      const day = base.getDay();
      const shift = day === 0 ? -6 : 1 - day;
      base.setDate(base.getDate() + shift);
      base.setHours(0,0,0,0);
      return Array.from({length:7}, (_,i)=>{
        const d = new Date(base);
        d.setDate(base.getDate()+i);
        return d;
      });
    }

    function monthDays(ref = new Date()){
      const y = ref.getFullYear();
      const m = ref.getMonth();
      const count = new Date(y, m+1, 0).getDate();
      return Array.from({length:count}, (_,i)=> new Date(y, m, i+1));
    }

    // ========= Habit logic =========
    function done(habit, dateKey){ return habit.completions.includes(dateKey); }

    function toggle(habitId, dateKey, checked){
      update((s)=>{
        const h = s.habits.find(x=>x.id===habitId);
        if(!h) return;
        const set = new Set(h.completions);
        if(checked) set.add(dateKey); else set.delete(dateKey);
        h.completions = [...set].sort();
      });
    }

    function countInRange(habit, dates){
      return dates.reduce((sum, d)=> sum + (done(habit, key(d)) ? 1 : 0), 0);
    }

    function lastDoneDaysAgo(habit){
      if(!habit.completions.length) return Infinity;
      const last = habit.completions[habit.completions.length - 1];
      const lastDate = new Date(last + 'T00:00:00');
      const today = new Date(); today.setHours(0,0,0,0);
      return Math.floor((today - lastDate) / (1000*60*60*24));
    }

    function currentStreak(habit){
      const today = new Date(); today.setHours(0,0,0,0);
      let streak = 0;
      for(let i=0; i<3650; i++){
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        if(done(habit, key(d))) streak++;
        else break;
      }
      return streak;
    }

    // ========= Sorting =========
    const CATEGORY_ORDER = ["Body","Mind","Order","Craft","Money","Relationships","Spirit","Other"];
    function catIndex(cat){
      const i = CATEGORY_ORDER.indexOf(cat);
      return i === -1 ? CATEGORY_ORDER.length : i;
    }
    function sortedHabits(){
      return [...appState.habits].sort((a,b)=>{
        const ca = catIndex(a.category), cb = catIndex(b.category);
        if(ca !== cb) return ca - cb;
        return a.name.localeCompare(b.name);
      });
    }

    // ========= Coach (less generic, still local-only) =========
    function coachInsights(){
      const now = new Date();
      const w = isoWeek(now);
      const m = monthDays(now);
      const dim = m.length;

      if(!appState.habits.length){
        return {
          headline: "Add 1 habit. Keep it small.",
          bullets: ["Start with one habit you can do in 5 minutes.", "Consistency beats intensity."]
        };
      }

      const rows = appState.habits.map(h=>{
        const weekDone = countInRange(h, w);
        const monthDone = countInRange(h, m);
        const weekPct = Math.round((weekDone/7)*100);
        const monthPct = Math.round((monthDone/dim)*100);
        const since = lastDoneDaysAgo(h);
        const streak = currentStreak(h);
        const risk =
          (since === Infinity ? 60 : Math.min(60, since*7)) +
          (weekPct < 30 ? 25 : weekPct < 60 ? 10 : 0) +
          (streak >= 3 ? -10 : 0);
        return {h, weekPct, monthPct, since, streak, risk};
      }).sort((a,b)=> b.risk - a.risk);

      const worst = rows[0];
      const todayKey = key(new Date());
      const missedToday = rows.filter(r=> !done(r.h, todayKey)).slice(0, 3);

      const headline = (worst.since >= 3 || worst.since === Infinity)
        ? `Fix the leak: "${worst.h.name}" (${worst.since === Infinity ? "never done" : `last done ${worst.since}d ago`}).`
        : `You’re stable. Execute clean today.`;

      const bullets = [];
      if(missedToday.length){
        bullets.push(`Today’s priorities: ${missedToday.map(x=>`"${x.h.name}"`).join(", ")}.`);
      }
      bullets.push(`Rule: if you miss 2+ days, shrink the habit until it’s impossible to fail.`);
      bullets.push(`Win condition: get 1 rep on the hardest habit first; everything else gets easier.`);
      bullets.push(`If a habit is “never done”, reduce scope and attach it to a fixed trigger (wake / lunch / bedtime).`);

      return {headline, bullets};
    }

    // ========= Colors =========
    function habitColor(h){
      const idx = ((h.colorIndex || 0) % PALETTE.length + PALETTE.length) % PALETTE.length;
      return PALETTE[idx];
    }

    // donut threshold colors (solid, no gradient)
    function thresholdColor(pct){
      if(pct < 25) return getCSS('--red');
      if(pct < 50) return getCSS('--amber');
      if(pct < 75) return getCSS('--blue');
      return getCSS('--green');
    }
    function getCSS(varName){
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    // ========= Rendering helpers =========
    function esc(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function safeFileName(name){
      return String(name || '')
        .trim()
        .replace(/[^a-z0-9_\-]+/gi,'_')
        .replace(/^_+|_+$/g,'')
        .slice(0, 60) || 'habit';
    }

    function setMeta(){
      const now = new Date();
      document.getElementById('dateMeta').textContent = now.toLocaleString(undefined, {
        weekday:'long', year:'numeric', month:'long', day:'numeric'
      });
    }

    function ringSVG(percent, color){
      const size=92, r=36, cx=size/2, cy=size/2;
      const c=2*Math.PI*r;
      const p=Math.max(0, Math.min(100, percent));
      const off=c*(1-p/100);
      return `
        <svg class="ring" viewBox="0 0 ${size} ${size}">
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#1b2236" stroke-width="10" />
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${color}" stroke-width="10"
                  stroke-linecap="round"
                  stroke-dasharray="${c}"
                  stroke-dashoffset="${off}"
                  transform="rotate(-90 ${cx} ${cy})"/>
          <text x="${cx}" y="${cy+4}" text-anchor="middle">${p}%</text>
        </svg>
      `;
    }

    function badgeForSince(days){
      if(days === Infinity) return {cls:'new', label:'NEW'};
      if(days >= 7) return {cls:'bad', label:'NEGLECTED'};
      if(days >= 3) return {cls:'warn', label:'SLIPPING'};
      return {cls:'ok', label:'ON TRACK'};
    }

    function sinceLabel(days){
      if(days === Infinity) return "Never completed";
      if(days === 0) return "Last done: today";
      if(days === 1) return "Last done: 1 day ago";
      return `Last done: ${days} days ago`;
    }

    // ========= Tabs + Layout =========
    function render(){
      setMeta();

      // sync top tabs
      document.querySelectorAll('[data-tab]').forEach(t=>t.classList.remove('active'));
      document.querySelector(`[data-tab="${appState.ui.activeTab}"]`)?.classList.add('active');

      // show/hide weekly-monthly switcher depending on tab
      const viewTabs = document.getElementById('viewTabs');
      viewTabs.style.display = (appState.ui.activeTab === 'habits') ? 'inline-flex' : 'none';

      // sync view tabs
      document.querySelectorAll('[data-view]').forEach(t=>t.classList.remove('active'));
      document.querySelector(`[data-view="${appState.ui.activeView}"]`)?.classList.add('active');

      const shell = document.getElementById('mainShell');
      shell.innerHTML = '';

      if(appState.ui.activeTab === 'habits'){
        shell.appendChild(renderHabitsTab());
      } else if(appState.ui.activeTab === 'insights'){
        shell.appendChild(renderInsightsTab());
      } else {
        shell.appendChild(renderOVRTab());
      }

      bindDynamic(shell);
    }

    function renderHabitsTab(){
      const wrap = document.createElement('section');
      wrap.className = 'section';
      wrap.id = 'opsSection';

      const head = document.createElement('div');
      head.className = 'section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">Operations</h2>
          <p class="section-sub">Check in. Immediate feedback. No fluff.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="ops" aria-label="Expand Operations">Expand</button>
          <button class="btn" data-close aria-label="Close Fullscreen">Close (Esc)</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'section-body';
      body.appendChild(renderHabitsGrid());

      wrap.appendChild(head);
      wrap.appendChild(body);
      return wrap;
    }

    function renderInsightsTab(){
      const wrap = document.createElement('section');
      wrap.className = 'section';
      wrap.id = 'insightsSection';

      const head = document.createElement('div');
      head.className = 'section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">Insights</h2>
          <p class="section-sub">Minimal signal. Ranked neglect. Coach actions.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="insights" aria-label="Expand Insights">Expand</button>
          <button class="btn" data-close aria-label="Close Fullscreen">Close (Esc)</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'section-body';
      body.appendChild(renderInsightsBody());

      wrap.appendChild(head);
      wrap.appendChild(body);
      return wrap;
    }

    function renderOVRTab(){
      const wrap = document.createElement('section');
      wrap.className = 'section';
      wrap.id = 'ovrSection';

      const head = document.createElement('div');
      head.className = 'section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">OVR</h2>
          <p class="section-sub">Earn your rank by staying consistent and well-rounded.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="ovr" aria-label="Expand OVR">Expand</button>
          <button class="btn" data-close aria-label="Close Fullscreen">Close (Esc)</button>
        </div>
      `;

      const body = document.createElement('div');
      body.className = 'section-body';
      body.appendChild(renderOVRBody());

      wrap.appendChild(head);
      wrap.appendChild(body);
      return wrap;
    }

    // ========= Habits Grid =========
    function renderHabitsGrid(){
      const container = document.createElement('div');

      const habits = sortedHabits();

      if(!habits.length){
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='No habits yet. Click “+ Habit”.';
        container.appendChild(e);
        return container;
      }

      const tableWrap = document.createElement('div');
      tableWrap.className='table-wrap';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const hr = document.createElement('tr');

      if(appState.ui.activeView === 'weekly'){
        const weekDates = isoWeek();
        const label = `Week (Mon–Sun): ${weekDates[0].toLocaleDateString()} → ${weekDates[6].toLocaleDateString()}`;

        hr.innerHTML = `<th>Habit</th>${['M','T','W','T','F','S','S'].map(d=>`<th>${d}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(hr);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');
          const doneCount = countInRange(h, weekDates);
          const pct = Math.round((doneCount/7)*100);
          const hc = habitColor(h);

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}" aria-label="Edit ${esc(h.name)}">
                <div class="habit-name">${esc(h.name)}</div>
                <div class="habit-meta"><span class="dot" style="background:${hc}"></span>${esc(h.category)}</div>
              </div>
            </td>
          `;

          weekDates.forEach(d=>{
            const dk = key(d);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td><input type="checkbox" style="--chk:${hc}" data-habit-id="${h.id}" data-date="${dk}" ${checked} aria-label="${esc(h.name)} ${dk}"></td>`;
          });

          row += `
            <td>
              <div class="progress">
                <div class="bar"><div class="fill" style="--fill:${hc}; width:${pct}%"></div></div>
                <div class="pct">${pct}%</div>
              </div>
            </td>`;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      } else {
        const now = new Date();
        const md = monthDays(now);
        const daysInMonth = md.length;

        hr.innerHTML = `<th>Habit</th>${Array.from({length:31}, (_,i)=>`<th>${i+1}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(hr);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');
          const doneCount = countInRange(h, md);
          const pct = Math.round((doneCount/daysInMonth)*100);
          const hc = habitColor(h);

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}" aria-label="Edit ${esc(h.name)}">
                <div class="habit-name">${esc(h.name)}</div>
                <div class="habit-meta"><span class="dot" style="background:${hc}"></span>${esc(h.category)}</div>
              </div>
            </td>
          `;

          for(let day=1; day<=31; day++){
            const date = md[day-1];
            if(!date){ row += `<td style="opacity:.35">—</td>`; continue; }
            const dk = key(date);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td><input type="checkbox" style="--chk:${hc}" data-habit-id="${h.id}" data-date="${dk}" ${checked} aria-label="${esc(h.name)} ${dk}"></td>`;
          }

          row += `
            <td>
              <div class="progress">
                <div class="bar"><div class="fill" style="--fill:${hc}; width:${pct}%"></div></div>
                <div class="pct">${pct}%</div>
              </div>
            </td>`;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      }

      tableWrap.appendChild(table);
      container.appendChild(tableWrap);
      return container;
    }

    // ========= Insights =========
    function renderInsightsBody(){
      const container = document.createElement('div');

      if(!appState.habits.length){
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='Add habits to see insights.';
        container.appendChild(e);
        return container;
      }

      const now = new Date();
      const m = monthDays(now);
      const dim = m.length;

      const ranked = sortedHabits().map(h=>{
        const monthDone = countInRange(h, m);
        const monthPct = Math.round((monthDone/dim)*100);
        const since = lastDoneDaysAgo(h);
        return { h, monthPct, since };
      });

      const neglected = [...ranked].sort((a,b)=> (b.since - a.since)).slice(0, 10);

      const grid = document.createElement('div');
      grid.className='grid';

      // left: minimalist donuts for ALL habits
      const cards = document.createElement('div');
      cards.className='cards';

      ranked.forEach(r=>{
        const pct = r.monthPct;
        const ringColor = thresholdColor(pct);

        const card = document.createElement('button');
        card.type='button';
        card.className='card';
        card.setAttribute('data-open-habit', r.h.id);
        card.setAttribute('aria-label', `Open details for ${r.h.name}`);
        card.innerHTML = `
          <div class="mini-card-top">
            <div class="mini-name">${esc(r.h.name)}</div>
            <span class="dot" style="background:${habitColor(r.h)}"></span>
          </div>
          <div class="ring-center">
            ${ringSVG(pct, ringColor)}
          </div>
        `;
        cards.appendChild(card);
      });

      // right: coach + neglected
      const right = document.createElement('div');
      right.style.display='flex';
      right.style.flexDirection='column';
      right.style.gap='12px';
      right.style.minHeight='0';

      const coachData = coachInsights();
      const coach = document.createElement('div');
      coach.className='coach';
      coach.innerHTML = `
        <div class="coach-head">
          <h3 class="coach-title">Coach</h3>
          <span class="pill">Local</span>
        </div>
        <div class="coach-box">
          <div style="font-weight:900">${esc(coachData.headline)}</div>
          <ul>${coachData.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>
        </div>
      `;

      const list = document.createElement('div');
      list.className='list';
      list.innerHTML = `<h3>Neglected</h3><div class="items"></div>`;
      const items = list.querySelector('.items');

      neglected.forEach(r=>{
        const b = badgeForSince(r.since);
        const item = document.createElement('button');
        item.type='button';
        item.className='item';
        item.setAttribute('data-open-habit', r.h.id);
        item.setAttribute('aria-label', `Open details for ${r.h.name}`);
        item.innerHTML = `
          <div>
            <div style="font-weight:900">${esc(r.h.name)}</div>
            <small>${esc(sinceLabel(r.since))}</small>
          </div>
          <div class="badge ${b.cls}">${b.label}</div>
        `;
        items.appendChild(item);
      });

      right.appendChild(coach);
      right.appendChild(list);

      grid.appendChild(cards);
      grid.appendChild(right);

      container.appendChild(grid);
      return container;
    }

    // ========= Habit Detail (kept minimal but useful) =========
    function renderHabitDetail(habitId){
      const h = appState.habits.find(x => x.id === habitId);
      const container = document.createElement('div');
      if(!h){
        container.className='empty';
        container.textContent='Habit not found.';
        return container;
      }
      // For now, just open the edit modal; detail view can come back later.
      openHabitModal('edit', h.id);
      container.className='empty';
      container.textContent='Opening editor…';
      return container;
    }

    // ========= OVR =========
    function computeOVR(){
      const now = new Date();
      const m = monthDays(now);
      const dim = m.length;

      if(!appState.habits.length){
        return { score:0, rank:"WOOD III", tierPct:0, nextLabel:"WOOD II", breakdown:"Add habits to start earning rank." };
      }

      const perHabit = appState.habits.map(h=>{
        const monthDone = countInRange(h, m);
        const monthPct = Math.round((monthDone/dim)*100);
        return {h, monthPct};
      });

      // consistency = average month%
      const avg = Math.round(perHabit.reduce((s,x)=>s+x.monthPct,0) / perHabit.length);

      // well-rounded = category coverage (0..1)
      const cats = new Set(perHabit.map(x=>x.h.category));
      const coverage = Math.min(1, cats.size / 5); // expects ~5 pillars

      // hard mode: penalize low coverage
      const score = Math.max(0, Math.min(100, Math.round(avg * (0.65 + 0.35*coverage))));

      // tiers
      const tiers = [
        {name:"WOOD", min:0, max:19, color:"#7c2d12"},
        {name:"STEEL", min:20, max:34, color:"#64748b"},
        {name:"BRONZE", min:35, max:49, color:"#b45309"},
        {name:"SILVER", min:50, max:64, color:"#94a3b8"},
        {name:"GOLD", min:65, max:79, color:"#eab308"},
        {name:"PLATINUM", min:80, max:92, color:"#22c55e"},
        {name:"EMERALD", min:93, max:100, color:"#10b981"}
      ];

      const t = tiers.find(x=> score >= x.min && score <= x.max) || tiers[0];

      // sub-rank I/II/III inside tier based on progress within tier range
      const span = Math.max(1, t.max - t.min + 1);
      const rel = (score - t.min) / span; // 0..1
      const sub = rel >= 0.66 ? "I" : rel >= 0.33 ? "II" : "III";

      // next tier label
      const tierIndex = tiers.indexOf(t);
      const next = tiers[Math.min(tiers.length-1, tierIndex+1)];
      const tierPct = Math.round(((score - t.min) / span) * 100);

      const breakdown = `Score ${score}/100 = consistency (${avg}%) × well-rounded (${Math.round(coverage*100)}%).`;

      return {
        score,
        rank: `${t.name} ${sub}`,
        tierPct,
        tierColor: t.color,
        nextLabel: tierIndex === tiers.length-1 ? "MAX" : next.name,
        breakdown
      };
    }

    function emblemSVG(rank, color){
      // simple emblem (solid, no gradients)
      const label = rank;
      return `
        <svg class="emblem" viewBox="0 0 200 200" aria-hidden="true">
          <path d="M100 12 L170 46 L170 112 Q170 158 100 188 Q30 158 30 112 L30 46 Z"
                fill="#0c0f19" stroke="${color}" stroke-width="6" />
          <path d="M100 28 L156 56 L156 110 Q156 146 100 170 Q44 146 44 110 L44 56 Z"
                fill="${color}" opacity="0.18" />
          <circle cx="100" cy="92" r="44" fill="#0f1320" stroke="${color}" stroke-width="6"/>
          <text x="100" y="98" text-anchor="middle" fill="#fff" font-size="16" font-weight="900" style="letter-spacing:1.5px;">
            ${esc(label)}
          </text>
        </svg>
      `;
    }

    function renderOVRBody(){
      const container = document.createElement('div');
      container.className = 'ovr-wrap';

      const ovr = computeOVR();

      const center = document.createElement('div');
      center.className = 'ovr-center';
      center.innerHTML = `
        ${emblemSVG(ovr.rank, ovr.tierColor || getCSS('--slate'))}
        <div class="ovr-rank">${esc(ovr.rank)}</div>
        <div class="ovr-sub">${esc(ovr.breakdown)}</div>
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="pill">Progress • ${ovr.tierPct}%</div>
          <div class="pill">Next • ${esc(ovr.nextLabel)}</div>
        </div>
      `;

      const actions = document.createElement('div');
      actions.className = 'list';
      actions.innerHTML = `
        <h3>Month Export</h3>
        <div class="items">
          <div class="item">
            <div>
              <div style="font-weight:900">Export this month snapshot (CSV)</div>
              <small>Paste into a spreadsheet to track month-over-month.</small>
            </div>
            <button class="btn primary" type="button" data-export-month>Export</button>
          </div>
        </div>
      `;

      container.appendChild(center);
      container.appendChild(actions);
      return container;
    }

    // ========= Dynamic Binding =========
    function bindDynamic(root){
      // checkboxes
      root.querySelectorAll('input[type="checkbox"]').forEach(box=>{
        box.addEventListener('change', (e)=>{
          const { habitId, date } = e.target.dataset;
          toggle(habitId, date, e.target.checked);
        });
      });
    }

    // ========= Modal =========
    function openHabitModal(mode, habitId=null){
      modalMode = mode;
      editingHabitId = habitId;

      const modal = document.getElementById('habitModal');
      modal.dataset.open = "true";
      modal.setAttribute('aria-hidden', 'false');

      const title = document.getElementById('habitModalTitle');
      const sub = document.getElementById('habitModalSub');
      const delBtn = document.getElementById('deleteHabitBtn');

      const nameInput = document.getElementById('habitNameInput');
      const catSelect = document.getElementById('habitCategorySelect');

      if(mode === 'add'){
        title.textContent = "Add Habit";
        sub.textContent = "Name it. Categorize it. Earn it.";
        delBtn.style.display = "none";
        nameInput.value = "";
        catSelect.value = "Body";
      } else {
        const h = appState.habits.find(x=>x.id===habitId);
        title.textContent = "Edit Habit";
        sub.textContent = "Fix name/category or delete.";
        delBtn.style.display = "inline-flex";
        nameInput.value = h ? h.name : "";
        catSelect.value = h ? h.category : "Other";
      }

      requestAnimationFrame(()=> nameInput.focus());
    }

    function closeHabitModal(){
      const modal = document.getElementById('habitModal');
      modal.dataset.open = "false";
      modal.setAttribute('aria-hidden', 'true');
      modalMode = "add";
      editingHabitId = null;
    }

    function nextColorIndex(){
      // simple: pick least-used color index to spread palette
      const used = new Map();
      appState.habits.forEach(h=>{
        used.set(h.colorIndex, (used.get(h.colorIndex)||0)+1);
      });
      let best = 0, bestCount = Infinity;
      for(let i=0;i<PALETTE.length;i++){
        const c = used.get(i)||0;
        if(c < bestCount){ bestCount = c; best = i; }
      }
      return best;
    }

    // ========= Controls =========
    function bindControls(){
      // top tabs
      document.querySelectorAll('[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          update(s=>{ s.ui.activeTab = btn.dataset.tab; });
        });
      });

      // view switcher
      document.querySelectorAll('[data-view]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          update(s=>{ s.ui.activeView = btn.dataset.view; });
        });
      });

      document.getElementById('addHabitBtn').addEventListener('click', ()=>{
        lastFocus = document.activeElement;
        openHabitModal('add');
      });

      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(appState, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-tracker-${key(new Date())}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('resetBtn').addEventListener('click', ()=>{
        const ok = confirm('Reset deletes habits + history on this device. Continue?');
        if(!ok) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      // modal buttons
      document.getElementById('habitModalClose').addEventListener('click', closeHabitModal);
      document.getElementById('cancelHabitBtn').addEventListener('click', closeHabitModal);

      document.getElementById('saveHabitBtn').addEventListener('click', ()=>{
        const name = document.getElementById('habitNameInput').value.trim();
        const cat = document.getElementById('habitCategorySelect').value;

        if(!name) return;

        if(modalMode === 'add'){
          update(s=>{
            s.habits.push({
              id: crypto.randomUUID(),
              name,
              category: cat,
              colorIndex: nextColorIndex(),
              created: new Date().toISOString(),
              completions: []
            });
          });
        } else if(modalMode === 'edit' && editingHabitId){
          update(s=>{
            const h = s.habits.find(x=>x.id===editingHabitId);
            if(!h) return;
            h.name = name;
            h.category = cat;
          });
        }
        closeHabitModal();
      });

      document.getElementById('deleteHabitBtn').addEventListener('click', ()=>{
        if(modalMode !== 'edit' || !editingHabitId) return;
        const ok = confirm('Delete this habit and its history?');
        if(!ok) return;
        update(s=>{
          s.habits = s.habits.filter(h=>h.id!==editingHabitId);
        });
        closeHabitModal();
      });
    }

    // ========= Expand-to-full =========
    function setExpanded(which) {
      lastFocus = document.activeElement;
      document.body.setAttribute('data-expanded', which);
      requestAnimationFrame(() => {
        const section =
          which === 'ops' ? document.getElementById('opsSection') :
          which === 'insights' ? document.getElementById('insightsSection') :
          document.getElementById('ovrSection');
        section?.querySelector('[data-close]')?.focus?.();
      });
    }

    function clearExpanded() {
      document.body.removeAttribute('data-expanded');
      render();
      const toFocus = lastFocus;
      lastFocus = null;
      requestAnimationFrame(() => toFocus?.focus?.());
    }

    // ========= Click / Key handling =========
    document.addEventListener('click', (e) => {
      // modal backdrop click closes
      const modal = document.getElementById('habitModal');
      if(modal?.dataset.open === "true"){
        const card = e.target.closest('.modal-card');
        const isInside = !!card;
        if(!isInside && e.target === modal) closeHabitModal();
      }

      // ignore interactive controls (prevents accidental opens later)
      if (e.target.closest('button.btn, input, label, a, select, textarea')) {
        // still allow edit habit cell clicks; those aren't button.btn
      }

      // edit by clicking habit cell
      const editCell = e.target.closest('[data-edit-habit]');
      if(editCell){
        const id = editCell.getAttribute('data-edit-habit');
        lastFocus = editCell;
        openHabitModal('edit', id);
        return;
      }

      // open habit "detail" (currently routes to editor)
      if (!e.target.closest('button.btn, input, label, a, select, textarea')) {
        const open = e.target.closest('[data-open-habit]');
        if(open){
          renderHabitDetail(open.getAttribute('data-open-habit'));
          return;
        }
      }

      const exp = e.target.closest('[data-expand]');
      if(exp){
        setExpanded(exp.getAttribute('data-expand'));
        return;
      }

      const close = e.target.closest('[data-close]');
      if(close){
        clearExpanded();
        return;
      }

      const exportMonth = e.target.closest('[data-export-month]');
      if(exportMonth){
        exportMonthCSV();
        return;
      }
    });

    document.addEventListener('keydown', (e) => {
      // modal esc
      const modal = document.getElementById('habitModal');
      if(e.key === 'Escape' && modal?.dataset.open === "true"){
        closeHabitModal();
        return;
      }

      const openable = e.target?.closest?.('[data-open-habit]');
      if (openable && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        renderHabitDetail(openable.getAttribute('data-open-habit'));
        return;
      }

      if (e.key === 'Escape' && document.body.hasAttribute('data-expanded')) {
        clearExpanded();
      }
    });

    // ========= Month export (CSV) =========
    function exportMonthCSV(){
      const now = new Date();
      const md = monthDays(now);
      const dim = md.length;

      const rows = [];
      rows.push(["Month", now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0')].join(","));
      rows.push(["Habit","Category","Color","Month %","Days done","Days in month"].join(","));

      sortedHabits().forEach(h=>{
        const doneCount = countInRange(h, md);
        const pct = Math.round((doneCount/dim)*100);
        rows.push([
          csvSafe(h.name),
          csvSafe(h.category),
          csvSafe(habitColor(h)),
          pct,
          doneCount,
          dim
        ].join(","));
      });

      const blob = new Blob([rows.join("\n")], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `habit-month-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function csvSafe(s){
      const str = String(s ?? "");
      if(/[,"\n]/.test(str)) return `"${str.replaceAll('"','""')}"`;
      return str;
    }

    // ========= Init =========
    function init(){
      bindControls();
      render();
    }
    init();
  </script>
</body>
</html>
