<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Habit Tracker</title>
  <style>
    :root{
      --bg:#0b0d12;
      --panel:#121522;
      --panel2:#0f1320;
      --border:#22283a;
      --text:#f5f7ff;
      --muted:#98a2b3;

      --purple:#7c3aed;
      --blue:#2563eb;
      --teal:#14b8a6;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;
      --pink:#ec4899;
      --slate:#64748b;

      --radius:16px;
      --shadow: 0 18px 40px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow-x:hidden;
    }

    .app{
      width:min(1120px, 94vw);
      margin:18px auto;
      display:grid;
      gap:14px;
      min-height:calc(100vh - 36px);
      grid-template-rows:auto 1fr auto;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    header{
      padding:14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      margin:0;
      font-size:1.05rem;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:900;
    }
    .meta{
      color:var(--muted);
      font-size:.86rem;
      font-weight:700;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .tabs{
      display:inline-flex;
      gap:6px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px;
    }
    .tab{
      border:0;
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.02em;
    }
    .tab.active{
      background:var(--blue);
      color:#fff;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      border-radius:12px;
      padding:9px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      border-color:transparent;
      background:var(--purple);
      color:#fff;
    }
    .btn.danger{
      border-color:transparent;
      background:var(--red);
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    main{
      padding:14px;
      display:grid;
      gap:14px;
      min-height:0;
    }

    /* Single page content area (we render per top tab) */
    .page{
      min-height:0;
      height:100%;
      display:grid;
      gap:14px;
      grid-template-rows: 0.95fr 1.05fr;
    }

    .section{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .section-title{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
      color:#e9ecff;
    }
    .section-sub{
      margin:4px 0 0;
      color:var(--muted);
      font-size:.85rem;
      font-weight:700;
    }

    .empty{
      border:1px dashed #3a425c;
      border-radius:14px;
      padding:18px;
      background:#0c0f19;
      color:var(--muted);
      text-align:center;
      font-weight:800;
    }

    /* Habits table */
    .table-wrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0c0f19;
      min-height:0;
      flex:1;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.05);
      padding:10px;
      text-align:center;
      font-size:.92rem;
      background:#0c0f19;
      white-space:nowrap;
    }
    th{
      position:sticky;
      top:0;
      z-index:3;
      background:#0f1320;
      color:#dbe1ff;
      font-size:.78rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
      border-bottom:1px solid var(--border);
    }

    /* Sticky first column (both weekly & monthly) */
    th:first-child,
    td:first-child{
      position:sticky;
      left:0;
      z-index:4;
      text-align:left;
      background:#0f1320;
      border-right:1px solid rgba(255,255,255,.06);
      min-width:260px; /* wider habit column */
      max-width:360px;
    }
    td:first-child{
      background:#0c0f19;
      z-index:2;
    }

    .habit-cell{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .habit-name{
      font-weight:900;
      letter-spacing:.01em;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cat-pill{
      font-size:.72rem;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#11162a;
      color:#dbe1ff;
      flex:0 0 auto;
    }

    input[type="checkbox"]{
      appearance:none;
      -webkit-appearance:none;
      width:22px;
      height:22px;
      border-radius:6px;
      border:1px solid #3a425c;
      background:#0b0d12;
      cursor:pointer;
      position:relative;
    }
    input[type="checkbox"]:checked{
      border-color:transparent;
      background:var(--blue); /* will be overridden inline per habit */
    }
    input[type="checkbox"]:checked::after{
      content:'';
      position:absolute;
      left:7px;
      top:2px;
      width:5px;
      height:11px;
      border:solid #fff;
      border-width:0 2px 2px 0;
      transform:rotate(45deg);
    }

    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
    }
    .bar{
      width:150px;
      height:10px;
      border-radius:999px;
      background:#141a2b;
      border:1px solid var(--border);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background:var(--purple); /* overridden inline per habit */
    }
    .pct{
      min-width:62px;
      text-align:right;
      color:var(--muted);
      font-weight:900;
      font-size:.85rem;
    }

    /* Insights layout */
    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1.25fr 0.75fr;
      min-height:0;
      flex:1;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
      min-height:0;
      align-content:start;
    }
    .cards.scrollable{
      overflow:auto;
      padding-right:4px;
      border-radius:12px;
      min-height:0;
    }

    /* Cards: visuals in .card, buttons only add behavior */
    .card{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      text-align:left;
      cursor:default;
    }
    button.card{
      cursor:pointer;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
    }
    button.card:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card-name{
      font-weight:900;
      line-height:1.15;
      letter-spacing:.01em;
    }

    .ring-wrap{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
    }
    .ring{
      width:84px;
      height:84px;
      flex:0 0 auto;
    }
    .ring text{
      font-weight:900;
      fill:#fff;
      font-size:10px;
      letter-spacing:.06em;
    }

    .pill{
      font-size:.75rem;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:#11162a;
      border:1px solid var(--border);
      color:#dbe1ff;
      white-space:nowrap;
    }

    .list{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .list h3{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .items{
      overflow:auto;
      padding-right:4px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#0f1320;
    }
    .item small{ color:var(--muted); font-weight:900; }

    /* Neglected rows are buttons */
    button.item{
      width:100%;
      cursor:pointer;

      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;

      appearance:none;
      -webkit-appearance:none;
      border:0;
      background:transparent;
      color:inherit;
      font:inherit;
      padding:0;
    }
    button.item:focus{
      outline:2px solid var(--blue);
      outline-offset:2px;
    }

    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:.75rem;
      color:#fff;
      white-space:nowrap;
    }
    .badge.ok{ background:var(--green); }
    .badge.warn{ background:var(--amber); }
    .badge.bad{ background:var(--red); }
    .badge.new{ background:var(--slate); }
    .badge.streak{ background:var(--purple); }

    .coach{
      display:flex;
      flex-direction:column;
      gap:10px;
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
    }
    .coach-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .coach-title{
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.88rem;
      margin:0;
    }
    .coach-box{
      border:1px solid var(--border);
      background:#0f1320;
      border-radius:14px;
      padding:10px;
      color:#dbe1ff;
      font-weight:800;
      line-height:1.35;
    }
    .coach-box ul{ margin:8px 0 0 18px; padding:0; }
    .coach-box li{ margin:6px 0; }

    /* OVR */
    .ovr-wrap{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr 1fr;
      min-height:0;
    }
    .ovr-hero{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }
    .emblem{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:20px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:220px;
    }
    .emblem svg{ width:180px; height:180px; }
    .ovr-stats{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:20px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-weight:900;
    }
    .kv b{ color:#e9ecff; }

    footer{
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .foot-note{ color:var(--muted); font-size:.82rem; font-weight:800; }

    @media (max-width: 980px){
      .page{ grid-template-rows:auto auto; }
      .grid{ grid-template-columns:1fr; }
      .cards{ grid-template-columns:1fr; }
      .ovr-wrap{ grid-template-columns:1fr; }
      table{ min-width:860px; }
      th:first-child, td:first-child{ min-width:220px; }
    }

    /* Expand-to-full system */
    body[data-expanded] { overflow: hidden; }
    body[data-expanded]::before{
      content:"";
      position:fixed;
      inset:0;
      background:#070912;
      opacity:.88;
      z-index:9998;
    }
    .section .section-body{
      min-height:0;
      overflow:auto;
      padding-top:2px;
      flex: 1 1 auto;
    }
    body[data-expanded="ops"] #insightsSection,
    body[data-expanded="insights"] #opsSection { display:none; }
    body[data-expanded] #opsSection,
    body[data-expanded] #insightsSection{
      position:fixed;
      inset:14px;
      z-index:9999;
      border-radius:var(--radius);
      background:var(--panel2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    [data-close]{ display:none; }
    body[data-expanded] [data-close]{ display:inline-flex !important; }
    body[data-expanded] [data-expand]{ display:none !important; }

    /* Modal (Add/Edit) */
    body[data-modal] { overflow:hidden; }
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:#070912;
      opacity:.88;
      z-index:10000;
      display:none;
    }
    body[data-modal] .modal-backdrop{ display:block; }
    .modal{
      position:fixed;
      inset:14px;
      z-index:10001;
      border-radius:var(--radius);
      background:var(--panel2);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      display:none;
      padding:14px;
    }
    body[data-modal] .modal{ display:flex; flex-direction:column; gap:12px; min-height:0; }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .modal-title{
      margin:0;
      font-size:.88rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
      color:#e9ecff;
    }
    .modal-body{
      border:1px solid var(--border);
      background:#0c0f19;
      border-radius:16px;
      padding:12px;
      min-height:0;
      display:grid;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .label{
      color:var(--muted);
      font-weight:900;
      font-size:.82rem;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .input, .select{
      border:1px solid var(--border);
      background:#0f1320;
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .row{ grid-template-columns:1fr; }
    }
    .modal-actions{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <h1>Habit Tracker</h1>
        <div class="meta" id="dateMeta"></div>
      </div>

      <div class="controls">
        <nav class="tabs" aria-label="Top Tabs">
          <button class="tab active" data-tab="habits">Habits</button>
          <button class="tab" data-tab="insights">Insights</button>
          <button class="tab" data-tab="ovr">OVR</button>
        </nav>

        <nav class="tabs" aria-label="View Switcher">
          <button class="tab active" data-view="weekly">Weekly</button>
          <button class="tab" data-view="monthly">Monthly</button>
        </nav>

        <button class="btn" id="exportBtn" title="Export full state as JSON">Export</button>
        <button class="btn primary" id="addHabitBtn">+ Habit</button>
      </div>
    </header>

    <main class="panel" id="mainShell"></main>

    <footer class="panel">
      <div class="foot-note">Saved locally on this device.</div>
      <button class="btn" id="resetBtn" title="Clear local data">Reset</button>
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" aria-hidden="true"></div>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-head">
      <div>
        <h2 class="modal-title" id="modalTitle">Add Habit</h2>
        <div class="section-sub" id="modalSub">Fast + clean. Name required.</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" type="button" data-modal-close>Close (Esc)</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="row">
        <div class="field">
          <div class="label">Habit name</div>
          <input class="input" id="habitName" autocomplete="off" placeholder="e.g., Read 10 pages" />
        </div>
        <div class="field">
          <div class="label">Category</div>
          <select class="select" id="habitCat">
            <option value="body">Body</option>
            <option value="mind">Mind</option>
            <option value="order">Order</option>
            <option value="craft">Craft</option>
            <option value="money">Money</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <div class="label">Color</div>
          <select class="select" id="habitColor"></select>
        </div>
        <div class="field">
          <div class="label">Preview</div>
          <div class="card" id="habitPreview" style="padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div style="font-weight:900" id="previewName">Habit</div>
              <div class="pill" id="previewCat">Category</div>
            </div>
            <div class="progress">
              <div class="bar"><div class="fill" id="previewFill" style="width:60%"></div></div>
              <div class="pct">60%</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn danger" type="button" id="deleteHabitBtn" style="display:none;">Delete</button>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" type="button" data-modal-cancel>Cancel</button>
        <button class="btn primary" type="button" id="saveHabitBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ========= Palette (24 solid colors) =========
    const COLOR_POOL = [
      {name:'Purple', value:'#7c3aed'},
      {name:'Blue', value:'#2563eb'},
      {name:'Teal', value:'#14b8a6'},
      {name:'Green', value:'#22c55e'},
      {name:'Amber', value:'#f59e0b'},
      {name:'Red', value:'#ef4444'},
      {name:'Pink', value:'#ec4899'},
      {name:'Slate', value:'#64748b'},

      {name:'Indigo', value:'#4f46e5'},
      {name:'Cyan', value:'#06b6d4'},
      {name:'Lime', value:'#84cc16'},
      {name:'Orange', value:'#f97316'},
      {name:'Rose', value:'#f43f5e'},
      {name:'Violet', value:'#8b5cf6'},
      {name:'Sky', value:'#0ea5e9'},
      {name:'Emerald', value:'#10b981'},

      {name:'Yellow', value:'#eab308'},
      {name:'Stone', value:'#78716c'},
      {name:'Fuchsia', value:'#d946ef'},
      {name:'Mint', value:'#34d399'},
      {name:'Azure', value:'#3b82f6'},
      {name:'Coral', value:'#fb7185'},
      {name:'Olive', value:'#65a30d'},
      {name:'Brick', value:'#dc2626'}
    ];

    // ========= State =========
    const STORAGE_KEY = 'habit-tracker-stack-v1_1';
    const appState = load() || {
      ui: { tab:'habits', activeView:'weekly', weekOffset:0, monthOffset:0 },
      habits: []
    };

    let insightsDetailHabitId = null; // future: per-habit detail
    let lastFocus = null;

    // Modal state
    let modalMode = 'add'; // 'add' | 'edit'
    let modalHabitId = null;

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || !Array.isArray(parsed.habits)) return null;
        if(!parsed.ui) parsed.ui = { tab:'habits', activeView:'weekly', weekOffset:0, monthOffset:0 };
        parsed.habits = parsed.habits.map(h => ({
          id: String(h.id || crypto.randomUUID()),
          name: String(h.name || 'Untitled Habit'),
          category: String(h.category || 'mind'),
          color: String(h.color || pickNextColor(parsed.habits).value),
          created: h.created || new Date().toISOString(),
          completions: Array.isArray(h.completions) ? h.completions : []
        }));
        return parsed;
      }catch{ return null; }
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

    function update(mutator){
      mutator(appState);
      save();
      render();
    }

    // ========= Dates =========
    function key(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function weekForOffset(weekOffset = 0){
      const ref = new Date();
      ref.setDate(ref.getDate() + (weekOffset*7));
      const base = new Date(ref);
      const day = base.getDay();
      const shift = day === 0 ? -6 : 1 - day;
      base.setDate(base.getDate() + shift);
      base.setHours(0,0,0,0);
      return Array.from({length:7}, (_,i)=>{
        const d = new Date(base);
        d.setDate(base.getDate()+i);
        return d;
      });
    }

    function monthDaysForOffset(monthOffset = 0){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + monthOffset;
      const first = new Date(y, m, 1);
      const count = new Date(first.getFullYear(), first.getMonth()+1, 0).getDate();
      return Array.from({length:count}, (_,i)=> new Date(first.getFullYear(), first.getMonth(), i+1));
    }

    function monthTitle(monthOffset = 0){
      const now = new Date();
      const d = new Date(now.getFullYear(), now.getMonth()+monthOffset, 1);
      return d.toLocaleString(undefined, {month:'long', year:'numeric'});
    }

    // ========= Habit logic =========
    function done(habit, dateKey){ return habit.completions.includes(dateKey); }

    function toggle(habitId, dateKey, checked){
      update((s)=>{
        const h = s.habits.find(x=>x.id===habitId);
        if(!h) return;
        const set = new Set(h.completions);
        if(checked) set.add(dateKey); else set.delete(dateKey);
        h.completions = [...set].sort();
      });
    }

    function countInRange(habit, dates){
      return dates.reduce((sum, d)=> sum + (done(habit, key(d)) ? 1 : 0), 0);
    }

    function lastDoneDaysAgo(habit){
      if(!habit.completions.length) return Infinity;
      const last = habit.completions[habit.completions.length - 1];
      const lastDate = new Date(last + 'T00:00:00');
      const today = new Date(); today.setHours(0,0,0,0);
      return Math.floor((today - lastDate) / (1000*60*60*24));
    }

    function lastDoneDate(habit){
      if(!habit.completions.length) return null;
      return habit.completions[habit.completions.length - 1];
    }

    function currentStreak(habit){
      const today = new Date(); today.setHours(0,0,0,0);
      let streak = 0;
      for(let i=0; i<3650; i++){
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        if(done(habit, key(d))) streak++;
        else break;
      }
      return streak;
    }

    function sortHabits(habits){
      const catOrder = { body:0, mind:1, order:2, craft:3, money:4 };
      return [...habits].sort((a,b)=>{
        const ca = catOrder[a.category] ?? 99;
        const cb = catOrder[b.category] ?? 99;
        if(ca !== cb) return ca - cb;
        return a.name.localeCompare(b.name);
      });
    }

    // ========= Colors =========
    function pickNextColor(existingHabits){
      const used = new Set((existingHabits||[]).map(h=>h.color));
      const next = COLOR_POOL.find(c=>!used.has(c.value)) || COLOR_POOL[existingHabits.length % COLOR_POOL.length];
      return next;
    }

    function statusColorByPct(pct){
      if(pct < 25) return getVar('--red');
      if(pct < 50) return getVar('--amber');
      return getVar('--green');
    }
    function getVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    // ========= Coach (less generic, data-driven) =========
    function coachInsights(){
      const m = monthDaysForOffset(appState.ui.monthOffset);
      const w = weekForOffset(appState.ui.weekOffset);
      const daysInMonth = m.length;

      const ranked = appState.habits.map(h=>{
        const weekDone = countInRange(h, w);
        const monthDone = countInRange(h, m);
        const since = lastDoneDaysAgo(h);
        const streak = currentStreak(h);
        const weekPct = Math.round((weekDone/7)*100);
        const monthPct = Math.round((monthDone/daysInMonth)*100);

        // risk: recency + low weekly execution
        const risk =
          (since === Infinity ? 70 : Math.min(70, since*8)) +
          (weekPct < 15 ? 25 : weekPct < 40 ? 15 : weekPct < 60 ? 8 : 0) +
          (streak >= 3 ? -10 : 0);

        return { h, weekDone, weekPct, monthDone, monthPct, since, streak, risk };
      }).sort((a,b)=> b.risk - a.risk);

      if(!appState.habits.length){
        return {
          headline: "Add 1 habit. Keep it small.",
          bullets: [
            "Start with one habit you can do in 5 minutes.",
            "Consistency beats intensity."
          ]
        };
      }

      const todayKey = key(new Date());
      const notDoneToday = ranked.filter(r => !done(r.h, todayKey));

      const worst = ranked[0];
      const best = [...ranked].sort((a,b)=> b.weekPct - a.weekPct)[0];

      const headline =
        worst.since === Infinity
          ? `Highest risk: "${worst.h.name}" is NEW — do the first rep today.`
          : worst.since >= 7
            ? `Highest risk: "${worst.h.name}" is NEGLECTED (${worst.since} days since last).`
            : worst.since >= 3
              ? `Highest risk: "${worst.h.name}" is SLIPPING (${worst.since} days since last).`
              : `Stability looks decent. Lock in today’s reps.`;

      const bullets = [];

      // Today targets: prioritize 1–3 habits not done today, biased by risk + categories
      const todayTargets = notDoneToday.slice(0,3).map(x=>`"${x.h.name}"`).join(', ');
      if(todayTargets) bullets.push(`Today: do ${todayTargets}.`);

      // Shrink rule: if missed 2+ days, reduce
      const shrinkList = ranked.filter(r=>r.since >= 2 && r.since !== Infinity).slice(0,2);
      if(shrinkList.length){
        bullets.push(`Shrink-to-win: ${shrinkList.map(r=>`"${r.h.name}"`).join(', ')} — make it impossible to fail (2 minutes).`);
      }

      // Protect momentum: best performer
      if(best){
        bullets.push(`Protect momentum: "${best.h.name}" is leading this week. Don’t break the chain.`);
      }

      // Quick system note
      bullets.push(`Rule: miss 2+ days → reduce effort, keep frequency.`);

      return { headline, bullets };
    }

    // ========= OVR / Rank =========
    const RANKS = [
      { tier:'Wood',   color:'#8b5a2b' },
      { tier:'Steel',  color:'#6b7280' },
      { tier:'Bronze', color:'#b45309' },
      { tier:'Silver', color:'#9ca3af' },
      { tier:'Gold',   color:'#eab308' },
      { tier:'Platinum', color:'#60a5fa' },
      { tier:'Emerald', color:'#22c55e' }
    ];

    function overallScore(){
      if(!appState.habits.length) return 0;

      const m = monthDaysForOffset(appState.ui.monthOffset);
      const daysInMonth = m.length;

      // completion score: average month completion across habits
      const monthPcts = appState.habits.map(h=>{
        const monthDone = countInRange(h, m);
        return (monthDone / daysInMonth) * 100;
      });
      const avgMonth = monthPcts.reduce((a,b)=>a+b,0) / monthPcts.length;

      // streak bonus: average streak capped
      const streaks = appState.habits.map(h=>Math.min(14, currentStreak(h)));
      const avgStreak = streaks.reduce((a,b)=>a+b,0) / streaks.length;

      // score 0–100
      const score = Math.max(0, Math.min(100, (avgMonth * 0.85) + (avgStreak * 1.1)));
      return Math.round(score);
    }

    function rankFromScore(score){
      // 7 tiers * 3 divisions = 21 steps
      const steps = 21;
      const idx = Math.max(0, Math.min(steps-1, Math.floor((score/100) * steps)));
      const tierIndex = Math.floor(idx / 3);
      const div = 3 - (idx % 3);
      const tier = RANKS[tierIndex] || RANKS[0];
      return { ...tier, div, idx };
    }

    function emblemSVG(tier, color){
      // Simple “badge” look (solid fills only). Emerald gets wings.
      const wing = tier === 'Emerald'
        ? `<path d="M18 60 C 6 54, 6 40, 18 36 C 18 44, 22 52, 30 56 Z" fill="${color}" opacity="1"/>
           <path d="M162 60 C 174 54, 174 40, 162 36 C 162 44, 158 52, 150 56 Z" fill="${color}" opacity="1"/>`
        : '';
      return `
        <svg viewBox="0 0 180 180" aria-hidden="true">
          ${wing}
          <path d="M90 18 L140 42 L156 96 L90 162 L24 96 L40 42 Z" fill="#0f1320" stroke="${color}" stroke-width="6"/>
          <circle cx="90" cy="88" r="44" fill="${color}" opacity="0.18"/>
          <circle cx="90" cy="88" r="32" fill="${color}" opacity="0.28"/>
          <path d="M90 52 L116 66 L116 98 C116 118 104 134 90 140 C76 134 64 118 64 98 L64 66 Z" fill="${color}" opacity="0.95"/>
          <circle cx="90" cy="88" r="10" fill="#0b0d12" opacity="0.8"/>
        </svg>
      `;
    }

    // ========= Rendering =========
    function esc(s){
      return String(s)
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    function safeFileName(name){
      return String(name || '')
        .trim()
        .replace(/[^a-z0-9_\-]+/gi,'_')
        .replace(/^_+|_+$/g,'')
        .slice(0, 60) || 'habit';
    }

    function setMeta(){
      const now = new Date();
      document.getElementById('dateMeta').textContent = now.toLocaleString(undefined, {
        weekday:'long', year:'numeric', month:'long', day:'numeric'
      });
    }

    function ringSVG(percent, color){
      const size=84, r=32, cx=size/2, cy=size/2;
      const c=2*Math.PI*r;
      const p=Math.max(0, Math.min(100, percent));
      const off=c*(1-p/100);
      return `
        <svg class="ring" viewBox="0 0 ${size} ${size}">
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="#1b2236" stroke-width="10" />
          <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${color}" stroke-width="10"
                  stroke-linecap="round"
                  stroke-dasharray="${c}"
                  stroke-dashoffset="${off}"
                  transform="rotate(-90 ${cx} ${cy})"/>
          <text x="${cx}" y="${cy+4}" text-anchor="middle">${p}%</text>
        </svg>
      `;
    }

    function neglectedBadge(since){
      if(since === Infinity) return { cls:'new', label:'NEW' };
      if(since >= 7) return { cls:'bad', label:'NEGLECTED' };
      if(since >= 3) return { cls:'warn', label:'SLIPPING' };
      return { cls:'ok', label:'ON TRACK' };
    }

    function render(){
      setMeta();
      const shell = document.getElementById('mainShell');
      shell.innerHTML = '';
      shell.appendChild(renderPage());
      bindDynamic(shell);
      syncTopControls();
    }

    function syncTopControls(){
      document.querySelectorAll('.tab[data-tab]').forEach(t=>{
        t.classList.toggle('active', t.dataset.tab === appState.ui.tab);
      });
      document.querySelectorAll('.tab[data-view]').forEach(t=>{
        t.classList.toggle('active', t.dataset.view === appState.ui.activeView);
      });
    }

    function renderPage(){
      const wrap = document.createElement('div');
      wrap.className = 'page';

      if(appState.ui.tab === 'ovr'){
        wrap.style.gridTemplateRows = '1fr';
        wrap.appendChild(renderOVR());
        return wrap;
      }

      // Habits + Insights are stacked as Operations + Insights
      const ops = document.createElement('section');
      ops.className='section';
      ops.id='opsSection';
      ops.appendChild(renderOpsHeader());
      const opsBody = document.createElement('div');
      opsBody.className='section-body';
      opsBody.appendChild(renderOpsBody());
      ops.appendChild(opsBody);

      const insights = document.createElement('section');
      insights.className='section';
      insights.id='insightsSection';
      insights.appendChild(renderInsightsHeader());
      const insBody = document.createElement('div');
      insBody.className='section-body';
      insBody.appendChild(renderInsightsBody());
      insights.appendChild(insBody);

      if(appState.ui.tab === 'habits'){
        wrap.appendChild(ops);
        wrap.appendChild(insights);
      } else {
        // Insights tab: still show ops (smaller) + insights (bigger) for flow
        wrap.appendChild(ops);
        wrap.appendChild(insights);
      }

      return wrap;
    }

    function renderOpsHeader(){
      const head = document.createElement('div');
      head.className='section-head';

      const viewLabel = appState.ui.activeView === 'weekly'
        ? (() => {
            const wd = weekForOffset(appState.ui.weekOffset);
            return `Week (Mon–Sun): ${wd[0].toLocaleDateString()} → ${wd[6].toLocaleDateString()}`;
          })()
        : `Month: ${monthTitle(appState.ui.monthOffset)}`;

      head.innerHTML = `
        <div>
          <h2 class="section-title">Operations</h2>
          <p class="section-sub">${esc(viewLabel)} • Click a habit name to edit</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="btn" type="button" data-nav="prev">Prev</button>
            <button class="btn" type="button" data-nav="today">Today</button>
            <button class="btn" type="button" data-nav="next">Next</button>
          </div>
          <button class="btn" data-expand="ops" aria-label="Expand Operations">Expand</button>
          <button class="btn" data-close aria-label="Close Fullscreen">Close (Esc)</button>
        </div>
      `;
      return head;
    }

    function renderOpsBody(){
      if(!appState.habits.length){
        const c = document.createElement('div');
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='No habits yet. Click “+ Habit”.';
        c.appendChild(e);
        return c;
      }

      const habits = sortHabits(appState.habits);
      const container = document.createElement('div');
      const tableWrap = document.createElement('div');
      tableWrap.className='table-wrap';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      if(appState.ui.activeView === 'weekly'){
        const weekDates = weekForOffset(appState.ui.weekOffset);
        trh.innerHTML = `<th>Habit</th>${['M','T','W','T','F','S','S'].map(d=>`<th>${d}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(trh);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');

          const doneCount = countInRange(h, weekDates);
          const pct = Math.round((doneCount/7)*100);

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}" role="button" tabindex="0" aria-label="Edit ${esc(h.name)}">
                <div class="habit-name">${esc(h.name)}</div>
                <span class="cat-pill">${esc(h.category.toUpperCase())}</span>
              </div>
            </td>`;

          weekDates.forEach(d=>{
            const dk = key(d);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td><input type="checkbox" data-habit-id="${h.id}" data-date="${dk}" ${checked} aria-label="${esc(h.name)} ${dk}" style="${checked ? `background:${h.color};` : ''}"></td>`;
          });

          row += `
            <td>
              <div class="progress">
                <div class="bar"><div class="fill" style="width:${pct}%; background:${h.color};"></div></div>
                <div class="pct">${pct}%</div>
              </div>
            </td>
          `;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      } else {
        const md = monthDaysForOffset(appState.ui.monthOffset);
        const daysInMonth = md.length;

        trh.innerHTML = `<th>Habit</th>${Array.from({length:31}, (_,i)=>`<th>${i+1}</th>`).join('')}<th>Progress</th>`;
        thead.appendChild(trh);

        const tbody = document.createElement('tbody');
        habits.forEach(h=>{
          const tr = document.createElement('tr');

          const doneCount = countInRange(h, md);
          const pct = Math.round((doneCount/daysInMonth)*100);

          let row = `
            <td>
              <div class="habit-cell" data-edit-habit="${h.id}" role="button" tabindex="0" aria-label="Edit ${esc(h.name)}">
                <div class="habit-name">${esc(h.name)}</div>
                <span class="cat-pill">${esc(h.category.toUpperCase())}</span>
              </div>
            </td>`;

          for(let day=1; day<=31; day++){
            const date = md[day-1];
            if(!date){ row += `<td style="opacity:.35">—</td>`; continue; }
            const dk = key(date);
            const checked = done(h, dk) ? 'checked' : '';
            row += `<td><input type="checkbox" data-habit-id="${h.id}" data-date="${dk}" ${checked} aria-label="${esc(h.name)} ${dk}" style="${checked ? `background:${h.color};` : ''}"></td>`;
          }

          row += `
            <td>
              <div class="progress">
                <div class="bar"><div class="fill" style="width:${pct}%; background:${h.color};"></div></div>
                <div class="pct">${pct}%</div>
              </div>
            </td>
          `;

          tr.innerHTML = row;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      }

      tableWrap.appendChild(table);
      container.appendChild(tableWrap);
      return container;
    }

    function renderInsightsHeader(){
      const head = document.createElement('div');
      head.className='section-head';
      head.innerHTML = `
        <div>
          <h2 class="section-title">Insights</h2>
          <p class="section-sub">Minimal signals. No fluff.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" data-expand="insights" aria-label="Expand Insights">Expand</button>
          <button class="btn" data-close aria-label="Close Fullscreen">Close (Esc)</button>
        </div>
      `;
      return head;
    }

    function renderInsightsBody(){
      const container = document.createElement('div');

      if(!appState.habits.length){
        const e = document.createElement('div');
        e.className='empty';
        e.textContent='Add habits to see insights.';
        container.appendChild(e);
        return container;
      }

      const md = monthDaysForOffset(appState.ui.monthOffset);
      const daysInMonth = md.length;

      const ranked = sortHabits(appState.habits).map(h=>{
        const monthDone = countInRange(h, md);
        const monthPct = Math.round((monthDone/daysInMonth)*100);
        const since = lastDoneDaysAgo(h);
        const streak = currentStreak(h);
        return { h, monthDone, monthPct, since, streak };
      });

      const grid = document.createElement('div');
      grid.className='grid';

      // Cards: show ALL habits (scroll inside)
      const cardsWrap = document.createElement('div');
      cardsWrap.className='cards scrollable';
      ranked.forEach((r)=>{
        const ringColor = statusColorByPct(r.monthPct);
        const card = document.createElement('button');
        card.type='button';
        card.className='card';
        card.setAttribute('data-open-habit', r.h.id);
        card.setAttribute('aria-label', `Open ${r.h.name}`);
        card.innerHTML = `
          <div class="card-top">
            <div class="card-name">${esc(r.h.name)}</div>
            <div class="pill">${esc(r.h.category.toUpperCase())}</div>
          </div>
          <div class="ring-wrap">
            ${ringSVG(r.monthPct, ringColor)}
          </div>
        `;
        cardsWrap.appendChild(card);
      });

      const right = document.createElement('div');
      right.style.display='flex';
      right.style.flexDirection='column';
      right.style.gap='12px';
      right.style.minHeight='0';

      // Coach (data-driven)
      const coachData = coachInsights();
      const coach = document.createElement('div');
      coach.className='coach';
      coach.innerHTML = `
        <div class="coach-head">
          <h3 class="coach-title">Coach</h3>
          <span class="pill">Live</span>
        </div>
        <div class="coach-box">
          <div style="font-weight:900">${esc(coachData.headline)}</div>
          <ul>${coachData.bullets.map(b=>`<li>${esc(b)}</li>`).join('')}</ul>
        </div>
      `;

      // Neglected (clear meaning: days since last completion)
      const neglected = [...ranked].sort((a,b)=> (b.since - a.since)).slice(0, 12);
      const list = document.createElement('div');
      list.className='list';
      list.innerHTML = `<h3>Neglected</h3><div class="items"></div>`;
      const items = list.querySelector('.items');

      neglected.forEach(r=>{
        const b = neglectedBadge(r.since);
        const last = lastDoneDate(r.h);
        const sub = (r.since === Infinity)
          ? `Never completed`
          : `${r.since} day(s) since last • Last: ${last}`;
        const item = document.createElement('button');
        item.type='button';
        item.className='item';
        item.setAttribute('data-open-habit', r.h.id);
        item.setAttribute('aria-label', `Open details for ${r.h.name}`);
        item.innerHTML = `
          <div>
            <div style="font-weight:900">${esc(r.h.name)}</div>
            <small>${esc(sub)}</small>
          </div>
          <div class="badge ${b.cls}">${b.label}</div>
        `;
        items.appendChild(item);
      });

      right.appendChild(coach);
      right.appendChild(list);

      grid.appendChild(cardsWrap);
      grid.appendChild(right);

      container.appendChild(grid);
      return container;
    }

    function renderOVR(){
      const wrap = document.createElement('section');
      wrap.className='section';
      wrap.id='ovrSection';

      const score = overallScore();
      const r = rankFromScore(score);

      wrap.innerHTML = `
        <div class="section-head">
          <div>
            <h2 class="section-title">OVR</h2>
            <p class="section-sub">Monthly performance, gamified. Earn it.</p>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button class="btn" type="button" data-export-month>Export Month CSV</button>
          </div>
        </div>

        <div class="section-body">
          <div class="ovr-wrap">
            <div class="ovr-hero">
              <div class="emblem">
                ${emblemSVG(r.tier, r.color)}
              </div>
              <div class="ovr-stats">
                <div class="kv"><span>Rank</span><b>${esc(r.tier)} ${r.div}</b></div>
                <div class="kv"><span>OVR</span><b>${score}</b></div>
                <div class="kv"><span>Month</span><b>${esc(monthTitle(appState.ui.monthOffset))}</b></div>
                <div class="kv"><span>Habits</span><b>${appState.habits.length}</b></div>
              </div>
            </div>

            <div class="list" style="min-height:0;">
              <h3>Month Snapshot</h3>
              <div class="items" id="ovrSnapshot"></div>
            </div>
          </div>
        </div>
      `;

      // snapshot list
      const md = monthDaysForOffset(appState.ui.monthOffset);
      const daysInMonth = md.length;

      const snap = wrap.querySelector('#ovrSnapshot');
      const habits = sortHabits(appState.habits);
      if(!habits.length){
        snap.innerHTML = `<div class="empty">Add habits to earn ranks.</div>`;
      } else {
        habits.forEach(h=>{
          const monthDone = countInRange(h, md);
          const pct = Math.round((monthDone/daysInMonth)*100);
          const since = lastDoneDaysAgo(h);
          const b = neglectedBadge(since);
          const row = document.createElement('div');
          row.className='item';
          row.innerHTML = `
            <div>
              <div style="font-weight:900">${esc(h.name)}</div>
              <small>${esc(h.category.toUpperCase())} • ${pct}% this month</small>
            </div>
            <div class="badge ${b.cls}">${b.label}</div>
          `;
          snap.appendChild(row);
        });
      }

      return wrap;
    }

    function bindDynamic(root){
      // checkbox toggles
      root.querySelectorAll('input[type="checkbox"]').forEach(box=>{
        box.addEventListener('change', (e)=>{
          const { habitId, date } = e.target.dataset;
          const checked = e.target.checked;
          toggle(habitId, date, checked);
        });
      });

      // habit cell click -> edit
      root.querySelectorAll('[data-edit-habit]').forEach(el=>{
        el.addEventListener('click', ()=>{
          openEditModal(el.getAttribute('data-edit-habit'), el);
        });
        el.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            openEditModal(el.getAttribute('data-edit-habit'), el);
          }
        });
      });
    }

    // ========= Controls =========
    function bindControls(){
      // top tabs
      document.querySelectorAll('.tab[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          update(s=>{ s.ui.tab = btn.dataset.tab; });
        });
      });

      // view switcher (weekly/monthly)
      document.querySelectorAll('.tab[data-view]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          update(s=>{
            s.ui.activeView = btn.dataset.view;
            // keep offsets as-is
          });
        });
      });

      // add habit (opens modal)
      document.getElementById('addHabitBtn').addEventListener('click', ()=>{
        openAddModal(document.getElementById('addHabitBtn'));
      });

      // export full state
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(appState, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-tracker-${key(new Date())}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        const ok = confirm('Reset deletes habits + history on this device. Continue?');
        if(!ok) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      // modal wiring
      document.querySelector('[data-modal-close]').addEventListener('click', closeModal);
      document.querySelector('[data-modal-cancel]').addEventListener('click', closeModal);
      document.querySelector('.modal-backdrop').addEventListener('click', closeModal);

      document.getElementById('saveHabitBtn').addEventListener('click', saveModalHabit);
      document.getElementById('deleteHabitBtn').addEventListener('click', deleteModalHabit);

      // modal inputs -> preview
      document.getElementById('habitName').addEventListener('input', updatePreview);
      document.getElementById('habitCat').addEventListener('change', updatePreview);
      document.getElementById('habitColor').addEventListener('change', updatePreview);
    }

    // ========= Modal =========
    function fillColorSelect(selected){
      const sel = document.getElementById('habitColor');
      sel.innerHTML = '';
      COLOR_POOL.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.value;
        opt.textContent = c.name;
        if(c.value === selected) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function openAddModal(opener){
      lastFocus = opener || document.activeElement;
      modalMode = 'add';
      modalHabitId = null;

      const next = pickNextColor(appState.habits);
      fillColorSelect(next.value);

      document.getElementById('modalTitle').textContent = 'Add Habit';
      document.getElementById('modalSub').textContent = 'Name required. Category + color included.';
      document.getElementById('habitName').value = '';
      document.getElementById('habitCat').value = 'mind';
      document.getElementById('deleteHabitBtn').style.display = 'none';

      updatePreview();
      document.body.setAttribute('data-modal','1');
      requestAnimationFrame(()=> document.getElementById('habitName').focus());
    }

    function openEditModal(habitId, opener){
      lastFocus = opener || document.activeElement;
      modalMode = 'edit';
      modalHabitId = habitId;

      const h = appState.habits.find(x=>x.id===habitId);
      if(!h) return;

      fillColorSelect(h.color);

      document.getElementById('modalTitle').textContent = 'Edit Habit';
      document.getElementById('modalSub').textContent = 'Update name/category/color or delete.';
      document.getElementById('habitName').value = h.name;
      document.getElementById('habitCat').value = h.category;
      document.getElementById('habitColor').value = h.color;

      document.getElementById('deleteHabitBtn').style.display = 'inline-flex';

      updatePreview();
      document.body.setAttribute('data-modal','1');
      requestAnimationFrame(()=> document.getElementById('habitName').focus());
    }

    function closeModal(){
      if(!document.body.hasAttribute('data-modal')) return;
      document.body.removeAttribute('data-modal');
      const toFocus = lastFocus;
      lastFocus = null;
      requestAnimationFrame(()=> toFocus?.focus?.());
    }

    function updatePreview(){
      const name = document.getElementById('habitName').value.trim() || 'Habit';
      const cat = document.getElementById('habitCat').value;
      const color = document.getElementById('habitColor').value;

      document.getElementById('previewName').textContent = name;
      document.getElementById('previewCat').textContent = cat.toUpperCase();
      document.getElementById('previewFill').style.background = color;
    }

    function saveModalHabit(){
      const name = document.getElementById('habitName').value.trim();
      const category = document.getElementById('habitCat').value;
      const color = document.getElementById('habitColor').value;

      if(!name) return;

      update((s)=>{
        if(modalMode === 'add'){
          s.habits.push({
            id: crypto.randomUUID(),
            name,
            category,
            color,
            created: new Date().toISOString(),
            completions: []
          });
        } else {
          const h = s.habits.find(x=>x.id===modalHabitId);
          if(!h) return;
          h.name = name;
          h.category = category;
          h.color = color;
        }
      });

      closeModal();
    }

    function deleteModalHabit(){
      if(modalMode !== 'edit' || !modalHabitId) return;
      const h = appState.habits.find(x=>x.id===modalHabitId);
      if(!h) return;
      const ok = confirm(`Delete "${h.name}" and its history?`);
      if(!ok) return;

      update((s)=>{
        s.habits = s.habits.filter(x=>x.id!==modalHabitId);
      });

      closeModal();
    }

    // ========= Expand-to-full =========
    function setExpanded(which){
      lastFocus = document.activeElement;
      document.body.setAttribute('data-expanded', which);
      requestAnimationFrame(() => {
        const section = which === 'ops'
          ? document.getElementById('opsSection')
          : document.getElementById('insightsSection');
        section?.querySelector('[data-close]')?.focus?.();
      });
    }

    function clearExpanded(){
      document.body.removeAttribute('data-expanded');
      render();
      const toFocus = lastFocus;
      lastFocus = null;
      requestAnimationFrame(() => toFocus?.focus?.());
    }

    // ========= CSV Export (Month) =========
    function exportMonthCSV(){
      const md = monthDaysForOffset(appState.ui.monthOffset);
      const daysInMonth = md.length;
      const title = monthTitle(appState.ui.monthOffset);

      const lines = [];
      lines.push(['Month', title].join(','));
      lines.push(['Habit','Category','Done','DaysInMonth','Percent','DaysSinceLast','LastDate'].join(','));

      const habits = sortHabits(appState.habits);
      habits.forEach(h=>{
        const doneCount = countInRange(h, md);
        const pct = Math.round((doneCount/daysInMonth)*100);
        const since = lastDoneDaysAgo(h);
        const last = lastDoneDate(h) || 'Never';
        lines.push([
          `"${h.name.replaceAll('"','""')}"`,
          h.category,
          doneCount,
          daysInMonth,
          pct,
          since === Infinity ? 'NA' : since,
          last
        ].join(','));
      });

      const blob = new Blob([lines.join('\n')], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `habit-month-${title.replaceAll(' ','_')}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ========= Global Events =========
    document.addEventListener('click', (e)=>{
      // Guard: interactive elements inside openables should not trigger open
      if (e.target.closest('button.btn, input, label, a, select, textarea')) {
        // allow normal behavior
      } else {
        const open = e.target.closest('[data-open-habit]');
        if(open){
          // minimalist: clicking cards/items opens edit modal (not a heavy detail view)
          openEditModal(open.getAttribute('data-open-habit'), open);
          return;
        }
      }

      const nav = e.target.closest('[data-nav]');
      if(nav){
        const dir = nav.getAttribute('data-nav');
        update(s=>{
          if(s.ui.activeView === 'weekly'){
            if(dir === 'prev') s.ui.weekOffset -= 1;
            if(dir === 'next') s.ui.weekOffset += 1;
            if(dir === 'today') s.ui.weekOffset = 0;
          } else {
            if(dir === 'prev') s.ui.monthOffset -= 1;
            if(dir === 'next') s.ui.monthOffset += 1;
            if(dir === 'today') s.ui.monthOffset = 0;
          }
        });
        return;
      }

      const expandBtn = e.target.closest('[data-expand]');
      if(expandBtn){
        setExpanded(expandBtn.getAttribute('data-expand'));
        return;
      }

      const closeBtn = e.target.closest('[data-close]');
      if(closeBtn){
        clearExpanded();
        return;
      }

      const monthExport = e.target.closest('[data-export-month]');
      if(monthExport){
        exportMonthCSV();
        return;
      }
    });

    document.addEventListener('keydown', (e)=>{
      // openables (cards/items) on Enter/Space
      const openable = e.target?.closest?.('[data-open-habit]');
      if(openable && (e.key === 'Enter' || e.key === ' ')){
        e.preventDefault();
        openEditModal(openable.getAttribute('data-open-habit'), openable);
        return;
      }

      // close modal
      if(e.key === 'Escape' && document.body.hasAttribute('data-modal')){
        closeModal();
        return;
      }

      // close expand
      if(e.key === 'Escape' && document.body.hasAttribute('data-expanded')){
        clearExpanded();
        return;
      }
    });

    // ========= Init =========
    function init(){
      // populate modal color select (default)
      fillColorSelect(COLOR_POOL[0].value);
      bindControls();
      render();
    }

    init();
  </script>
</body>
</html>
